<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25" zv="Cache for UNIX (Red Hat Enterprise Linux 5 for x86-64) 2011.1.2 (Build 701)" ts="2014-04-25 16:37:05">
<Routine name="VEFAALR6" type="INT" languagemode="0" timestamp="63270,68247.488241"><![CDATA[
VEFAALR6 ;GOW/THC VEFA - Module for AWARE report gathering into an Alert Audit Log or Cache[ 12/01/2010 ]
 ;;1.0;VEFA;**1**;1-MAY-11;Build 17
FOLLOWU1(X)  ; FAT  LOOK STATUS + EXTRA COLUMN FOR FAT PROVIDER ( IF FAT SATISFIED)
 N RY1,RY,XX,RY2
 S XX=X
 S RY2=""
 S RY1=$$ORDERCK(XX)
 S RY1=$P(RY1,";",1)
 I RY1'="" S RY2=$P($G(^VA(200,RY1,0)),"^",1)_" - "_RY1
 S RY=$$FOLLOWUP(XX)
 I RY="ONE OR MORE FAT ORDERS/FOLLOW-UPS MADE" S RY=RY_"^"_RY2 Q RY  ;S RY=RY_"^"_RY2 Q RY 
 S RY=RY_"^"
 Q RY
ORDERCK(X) ;
 ;RETURN LIST OF ORDER FOLLOWUP ACTION THAT HAVE BEEN DONE. FROM ACKNOWLEDGED (DELETED) ALERT DATE TIME OR CURENT TIME BACK TO DATE OF ALERT
 N D0,RY,VEFADFN,VEFAPRV,VEFADTIM,VEFARETN,VEFAFOLP,ZP,RY,VEFADSPL,VEFADELD
 N VEFANAME
 S D0=X
 S VEFADFN=$P($G(^XTV(8992.1,D0,0)),"^",4)
 S VEFADTIM=$P($P($G(^XTV(8992.1,D0,0)),"^",1),";",3)
 S VEFARETN=$$SERVIC1^VEFAALR1(X)
 S VEFANAME=$P(VEFARETN,"^",3)
 S VEFAPRV=$P(VEFARETN,"^",2)
 S VEFADSPL=$P($G(^XTV(8992.1,D0,0)),"^",1)
 ;W !,"VEFADSPL=",VEFADSPL
 ;GET ACKNOWLEDGED(DELETED) DATE (IF ANY)
 S VEFADELD=$$STATUS1^VEFAALR1(X)
 S VEFADELD=$P(VEFADELD,"^",3)
 S ZP=VEFADFN_"^"_VEFAPRV_"^"_VEFANAME_"^"_VEFADTIM_"^"_VEFADELD
 ;W !,"ZP=",ZP
 S RY=""
 D LKPORDCK(.RY,ZP)  ;
 ;D LKPORDCK^VEFAALRE(.RY,ZP)  ;Do a lookup for specific critical alert TYPE, and associated date/time of a real unacknowledged alert,and RETURN list of
 ;any ORDERS by ordering provider user (DUZ) that have been made from list of available FAT (Follow-up Alert Tracking) orders in in specifi defined VEFA ALERT TRACKING entry's Reminder Dialog 
 ; multiples(and fields)with a Reminder Dialog, the dialog elements thereof containing the ORDER types (orderable iems) for such list 
 ;to be compared with any actual orders NOT by any ordering provider user(s) (DUZ) made after the date/time of the actual critical alert UP to NOW or
 ;to date of acknowledgement(deletion) OR now time (if not passed). Do this search in reverse chronological order.
 ;First Verify also that type of alert passed is in VEFA ALERT TRACKING file for "followup" purposes, and has defined REMINDER DIALOG
 ; INPUT 
 ;  ZP = DFN ^ DUZ ^ TYPE OF ALERT ^ DATE/TIME OF UNACK CRIT ALERT ^ DATE ACKNOWLEDGED(DELETED) 
 ; RETURN
 ;  RY= ORDERING PROVIDER OFORDER/FOLLOW-UP ACTION (IF ANY)FOLLOWED BY ";" AND THEN CONCATENATED STRING OF ACTUAL ORDERS MADE EACH SEPARATED WITH ";"
 ;  
 ;
 Q RY
FOLLOWUP(X) ;
 ;RETURN WHETHER ANY ORDER/FOLLOWUP ACTION HAS BEEN DONE. ACKNOW
 N D0,RY,VEFADFN,VEFAPRV,VEFADTIM,VEFARETN,VEFAFOLP,ZP,RY,VEFADSPL
 N VEFANAME
 N VEFADELD
 S D0=X
 S VEFADFN=$P($G(^XTV(8992.1,D0,0)),"^",4)
 S VEFADTIM=$P($P($G(^XTV(8992.1,D0,0)),"^",1),";",3)
 S VEFARETN=$$SERVIC1^VEFAALR1(X)
 S VEFANAME=$P(VEFARETN,"^",3)
 S VEFAPRV=$P(VEFARETN,"^",2)
 S VEFADSPL=$P($G(^XTV(8992.1,D0,0)),"^",1)
 ;W !,"VEFADSPL=",VEFADSPL
 ;GET ACKNOWLEDGED(DELETED) DATE (IF ANY)
 S VEFADELD=$$STATUS1^VEFAALR1(X)
 S VEFADELD=$P(VEFADELD,"^",3)
 S ZP=VEFADFN_"^"_VEFAPRV_"^"_VEFANAME_"^"_VEFADTIM_"^"_VEFADELD
 ;W !,"ZP=",ZP
 S RY=""
 D LKPORD(.RY,ZP) ;
 ;D LKPORD^VEFAALR2(.RY,ZP)  ;Do a lookup for specific critical alert TYPE, and associated date/time of a real unacknowledged alert,and check whether
 ;any ORDERS by user (DUZ)have been made from list of orders in in a possible defined VEFA ALERT TRACKING entry's Reminder Dialog 
 ;(field), the dialog elements thereof containing the ORDER types (orderable iems) for such list to be compared with any actual orders 
 ;by this user (DUZ) made after the date/time of the actual critical alert. 
 ;First Verify also that type of alert passed is in VEFA ALERT TRACKING file for "followup" purposes, and has defined REMINDER DIALOG
 ; if 
 ;  ZP = DFN ^ DUZ ^ TYPE OF ALERT ^ DATE/TIME OF UNACK CRIT ALERT  ^ DELETED DATE/TIME(IF ANY)
 ;  RY= 0 (1ST PIECE=0) NO ORDERS FOUND YET
 ;  RY= 0_"^"_3  ; (1ST PIECE=0)MEANS ORDER(S) FOUND BUT NONE NOT COMPLETED OR READY FOR SIG OR NONE OF THOSE COMPLETED WITH SIG REQUIRED HAVE SIGNATURE
 ;  RY =2_"^"_1  (1ST PIECE=2) if at least one ORDER found satisfying criteria complete/signed
 ;  RY= 3_"^"_2  ;(1ST PIECE=3) MEANS NO ALERT TRACKING FILE ENTRY FOUND FOR THIS TYPE OF ALERT 
 ;  RY= 3_"^"_3  ; (1ST PIECE=3)MEANS NO REMINDER DIALOG FOUND IN ALERT TRACKINg FILE FOR THIS TYPE OF ALERT
 ;
 I RY=0 S RY="NO FAT ORDERS MADE" Q RY
 I $E(RY,1,1)=0 I $E(RY,3,3)=3 S RY="FAT ORDER(S) MADE BUT NOT COMPLETED OR SIGNED" Q RY
 I $E(RY,1,1)=2 I $E(RY,3,3)=1 S RY="ONE OR MORE FAT ORDERS/FOLLOW-UPS MADE" Q RY
 Q RY
LKPORD(RY,ZP) ;Do a lookup for specific critical alert TYPE, and associated date/time of a real unacknowledged alert,and check whether 
 ;any ORDERS by ordering provider user (DUZ)have been made from list of orders in in a possible defined VEFA ALERT TRACKING entry's Reminder Dialog 
 ;(field), and with a Reminder Dialog, the dialog elements thereof containing the ORDER types (orderable iems) for such list to be compared with any actual orders 
 ;by this user (DUZ) made after the date/time of the actual critical alert. 
 ;First Verify also that type of alert passed is in VEFA ALERT TRACKING file for "followup" purposes, and has defined REMINDER DIALOG
 ; if 
 ;  ZP = DFN ^ DUZ ^ TYPE OF ALERT ^ DATE/TIME OF UNACK CRIT ALERT  ^ DELETED DATE/IME
 ;  RY= 0 (1ST PIECE=0) NO ORDERS FOUND YET
 ;  RY= 0_"^"_3  ; (1ST PIECE=0)MEANS ORDER(S) FOUND BUT NONE NOT COMPLETED OR READY FOR SIG OR NONE OF THOSE COMPLETED WITH SIG REQUIRED HAVE SIGNATURE
 ;  RY =2_"^"_1  (1ST PIECE=2) if at least one ORDER OR FOLLOWUP ACTION found satisfying criteria complete/signed
 ;  RY= 3_"^"_2  ;(1ST PIECE=3) MEANS NO ALERT TRACKING FILE ENTRY FOUND FOR THIS TYPE OF ALERT 
 ;  RY= 3_"^"_3  ; (1ST PIECE=3)MEANS NO REMINDER DIALOG FOUND IN ALERT TRACKINg FILE FOR THIS TYPE OF ALERT
 ;
 N VEFADFN,VEFADUZ,VEFAALRT,VEFAADTT,VEFARMDL
 N VEFACNT,VEFACNT1,VEFACNT2
 N DISABLE,REMDIALG,DIALOGTY,DIALOGEL,RESOLTYP,ORDRITM,COUNTER,CNTORD,CNT1,ORDER,CNTTIMO,CNTTIMA,REVERST,CNTPAT,ORDERCK
 N RYY,ACTION,ACTIONK,SIGSTAT
 N FOLLUPCT,FOLLOWAC
 N VHEALTH,OVERFLAG,VHEALF,FOLLOWUP,VISITPTR
 N DELETEDT
 N ACTIVE,COUNTER1,ORDERITEM,REMTYPE,VHEALFT
 N INITDATE
 ;K RY
 S RY=0
 S COUNTER=0 ; FOR ORDERS
 S COUNTER1=0  ; FOR FOLLOWUP ACTIONS
 K ^TMP($J,"ORDERITEM")
 K ^TMP($J,"FOLLOWUPITEM")
 S VEFADFN=$P(ZP,U,1) S VEFADUZ=$P(ZP,U,2) S VEFAALRT=$P(ZP,U,3) S VEFAADTT=$P(ZP,U,4) S DELETEDT=$P(ZP,U,5)
 ;
 ;first CHECK if type of alert if in VEFA ALERT TRACKING file
 S VEFACNT=0
 ;
 S VEFACNT=$O(^DIZ(19007,"B",VEFAALRT,VEFACNT))
 S ACTIVE=0
 S INITDATE=0
 I VEFACNT'="" D
 .S ACTIVE=$P($G(^DIZ(19007,VEFACNT,3)),"^",5)
 .I ACTIVE="" S ACTIVE=0
 .S INITDATE=$P($G(^DIZ(19007,VEFACNT,3)),"^",4)
 .I INITDATE="" S INITDATE=0
 ;I (VEFACNT'="")&(ACTIVE) D
 I (VEFACNT'="")&(INITDATE'=0)&(VEFAADTT>INITDATE) D
 .;
 .; RECORD # in VEFA TRACKED ALERTS file
 .; get reminder dialog 
 .S VEFARMDL=$P($G(^DIZ(19007,VEFACNT,3)),U,1) ;
 .I VEFARMDL'="" D
 ..;
 ..;GO TO FILE 801.41
 ..;CHECK IF DISABLED
 ..S DISABLE=$P($G(^PXRMD(801.41,VEFARMDL,0)),U,3)
 ..I (DISABLE=0)!(DISABLE="") D
 ...;
 ...;CHECK REMINDER TYPE AS "REMINDER DIALOG"
 ...S REMTYPE=$P($G(^PXRMD(801.41,VEFARMDL,0)),U,4)
 ...I REMTYPE="R" D
 ....;
 ....; LOOK THROUGH DIALOG GROUPS AND THEIR ELEMENTS TO FIND ORDERABLE ANY ORDER ITEMS.
 ....S VEFACNT=0
 ....F  S VEFACNT=$O(^PXRMD(801.41,VEFARMDL,10,"B",VEFACNT)) Q:VEFACNT=""  D
 .....;GET INTERNAL ENTRY #
 .....S VEFACNT1=0
 .....S VEFACNT1=$O(^PXRMD(801.41,VEFARMDL,10,"B",VEFACNT,VEFACNT1))
 .....;
 .....I VEFACNT1'="" D
 ......; GET DIALOG GROUP OR DIRECT DIALOG ELEMENT (ASSUME FOR NOW ONLY DIALOG GROUP WITH ORDERS)
 ......S REMDIALG=$P($G(^PXRMD(801.41,VEFARMDL,10,VEFACNT1,0)),U,2)
 ......;
 ......I REMDIALG'="" D
 .......; CHECK IF DIALOG GROUP
 .......S DIALOGTY=$P($G(^PXRMD(801.41,REMDIALG,0)),U,4)
 .......I DIALOGTY="G" D   ; DIALOG GROUP
 ........;
 ........S VEFACNT2=0 ; GET DIALOG ELEMENTS INSIDE THIS DIALOG GROUP
 ........F  S VEFACNT2=$O(^PXRMD(801.41,REMDIALG,10,"B",VEFACNT2)) Q:VEFACNT2=""  D
 .........;GET INTERNAL ENTRY #
 .........S DIALOGEL=0
 .........S DIALOGEL=$O(^PXRMD(801.41,REMDIALG,10,"B",VEFACNT2,DIALOGEL))
 .........; DIALOG ELEMENT
 .........;
 .........S DIALOGEL=$P($G(^PXRMD(801.41,REMDIALG,10,DIALOGEL,0)),U,2)
 .........;
 .........;CHECK "ORDER" RESOLUTION TYPE FIRST
 .........S RESOLTYP=$P($G(^PXRMD(801.41,DIALOGEL,1)),U,3)
 .........I RESOLTYP=3 D
 ..........;GET ORDERABLE ITEMS FILE ENTRY AS POSSIBLE FOLLOW-UP ACTION CHOICE. STORE INTO ^TMP($J,"ORDERITEM,COUNTER) ARRAY
 ..........S ORDERITEM=$P($G(^PXRMD(801.41,DIALOGEL,1)),U,7)
 ..........; NOW LOOK AT ORDERS IF ANY AND CHECK DATE/TIME > DATE/TIME OF PASSED CRIT ALERT
 ..........S COUNTER=COUNTER+1
 ..........;
 ..........S ^TMP($J,"ORDERITEM",COUNTER)=ORDERITEM
 ..........;new section
 ..........S FOLLUPCT=0
 ..........F  S FOLLUPCT=$O(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT)) Q:(FOLLUPCT="")!(FOLLUPCT="B")  D
 ...........S FOLLOWAC=$P($G(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT,0)),"^",1)  ;DYNAMIC POINTER
 ...........;LOOK FOR V HEALTH FACTOR TYPE ONLY
 ...........;GET FOLLOUP ACTION HEALTH FACTOR AS ADDITIONAL FINDING TYPE IN FORM "500156;AUTTHF(" WHERE NUMERIC LIKE 500156 IS INTERNAL # FOR HEALTH FACTOR ENTRY
 ...........I FOLLOWAC["AUTTHF(" D
 ............S COUNTER1=COUNTER1+1
 ............S ^TMP($J,"FOLLOWUPITEM",COUNTER1)=FOLLOWAC
 ..........;end section
 .........E  D
 ..........S FOLLUPCT=0
 ..........F  S FOLLUPCT=$O(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT)) Q:(FOLLUPCT="")!(FOLLUPCT="B")  D
 ...........S FOLLOWAC=$P($G(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT,0)),"^",1)  ;DYNAMIC POINTER
 ...........;LOOK FOR V HEALTH FACTOR TYPE ONLY
 ...........;GET FOLLOUP ACTION HEALTH FACTOR AS ADDITIONAL FINDING TYPE IN FORM "500156;AUTTHF(" WHERE NUMERIC LIKE 500156 IS INTERNAL # FOR HEALTH FACTOR ENTRY
 ...........I FOLLOWAC["AUTTHF(" D
 ............S COUNTER1=COUNTER1+1
 ............S ^TMP($J,"FOLLOWUPITEM",COUNTER1)=FOLLOWAC
 ....;  NOW GET ORDERS BY PATIENT AND PROVIDER (DUZ) DOESN'T CARE AS ORDER COULD BE MADE AMONG ANY PROVIDE IN OE/RR GROUP DEFINED
 ....; FOR SPECIFIC CRIT ALERT PROCESSING.BUT SHOULD MOST LIKELY BE MADE BY ORDERING PROVIDER. GET ORDERS STARTING IN REVERSE TIME ORDER 
 ....;UNTIL DATE/TIME OF ANY ORDER < 
 ....;DATE/TIME OF CRIT ALERT,OR NO ORDER FOUND IS ENCOUNTERED. SEARCH AMONG ORDERITEM LIST FOUND BEFORE END OF SEARCH IS OVER.
 ....;GO BY PATIENT FIRST
 ....S CNTTIMO=0  ; DATE/TIME OF ORDER ABD CNTTIMA DATE/TIME OF UNACK CRIT ALERT
 ....S CNTPAT=VEFADFN_";DPT("
 ....;
 ....F  S CNTTIMO=$O(^OR(100,"AC",CNTPAT,CNTTIMO)) S REVERST=9999999-CNTTIMO Q:(CNTTIMO="")!(VEFAADTT>REVERST)!(RY="0_""^""_3")!(RY="2_""^""_1")  D
 .....S ORDER=0
 .....I DELETEDT'="" I '(REVERST<DELETEDT) Q
 .....S ORDER=$O(^OR(100,"AC",CNTPAT,CNTTIMO,ORDER))
 .....;
 .....I ORDER'="" D
 ......;
 ......S CNT1=0  ; SEARCH MULTIPLE ORDERABLE ITEMS WITHIN 1 ORDER
 ......F  S CNT1=$O(^OR(100,ORDER,.1,"B",CNT1)) Q:(CNT1="")  D
 .......S CNTORD=CNT1
 .......;
 .......;S CNTORD=$P($G(^OR(100,ORDER,.1,CNT1,0)),"^",1)
 .......;CHECK IF AT LEAST ONE ORDERABLE ITEM OF ORDER AMONG LIST OF ORDERABLE ITEMS FOR FOLLOW-UP ACTION
 .......S COUNTER=0
 .......F  S COUNTER=$O(^TMP($J,"ORDERITEM",COUNTER)) Q:COUNTER=""  D
 ........S ORDERCK=$G(^TMP($J,"ORDERITEM",COUNTER))
 ........;
 ........I ORDERCK=CNTORD D
 .........S RYY=2  ; FOUND
 .........S SIGSTAT=1
 .........;NOT CHECK IF SIGNATURE REQUIRED AND SIGNATURE ITSELF
 .........I $P($G(^OR(100,ORDER,0)),"^",16)=2 D      ;ORES
 ..........S ACTION=0
 ..........S SIGSTAT=0
 ..........F  S ACTION=$O(^OR(100,ORDER,8,ACTION)) Q:(ACTION="")!(ACTION="C")  D
 ...........S ACTIONK=ACTION
 ...........S SIGSTAT=$P($G(^OR(100,ORDER,8,ACTION,0)),"^",4)
 ..........; CHECK FOR SIG STAT=1 FOR SIGNED ORDER ("ELECTRONIC") 
 ..........I RY'[1 S RY=RYY_"^"_SIGSTAT  ;SIGSTAT = 1 MEANS NO SIG REQUIRED OR SIG REQUIRED AND FOUND 
 .........E  D
 ..........S RY=RYY_"^"_1
 .........;
 ......;
 ......I RY'=0 I RY'[1 S RY=0_"^"_3      ; IE. IF RY NOT= 2_"^"_1 S RY=0_"^"_3
 ....;
 ....I RY=0 D
 .....;
 .....;  NOW GET V HEALTH FACTORS BY PATIENT 
 .....; FOR SPECIFIC CRIT ALERT PROCESSING.GET V HEALTH FACTORS STARTING IN REVERSE TIME ORDER 
 .....;UNTIL DATE/TIME OF ANY FOLLOWUP ACTION (V HEALTH FACTOR)< 
 .....;DATE/TIME OF CRIT ALERT,OR NO V  HEALTH FACTOR FOUND IS ENCOUNTERED. SEARCH AMONG FOLLOWUP LIST FOUND BEFORE END OF SEARCH IS OVER.
 .....;GO BY PATIENT FIRST
 .....S VHEALTH=""
 .....S OVERFLAG=0
 .....F  S VHEALTH=$O(^AUPNVHF("C",VEFADFN,VHEALTH),-1) Q:(VHEALTH="")!(OVERFLAG=1)  D
 ......S VISITPTR=$P($G(^AUPNVHF(VHEALTH,0)),"^",3)
 ......I VISITPTR'="" S REVERST=$P($G(^AUPNVSIT(VISITPTR,0)),"^",1)
 ......;
 ......;
 ......I VEFAADTT>REVERST S OVERFLAG=1 Q
 ......I DELETEDT'="" I '(REVERST<DELETEDT) Q
 ......S VHEALFT=$P($G(^AUPNVHF(VHEALTH,0)),"^",1)
 ......;
 ......;CHECK IF THIS HEALTH FACTOR WITHIN DATE/TIME ALLOWED IS ONE OF FOLLOWUP ACTION HEALTH FACTORS
 ......S COUNTER1=0
 ......F  S COUNTER1=$O(^TMP($J,"FOLLOWUPITEM",COUNTER1)) Q:(COUNTER1="")  D
 .......S FOLLOWUP=$G(^TMP($J,"FOLLOWUPITEM",COUNTER1))
 .......;
 .......I FOLLOWUP[VHEALFT D
 ........S RY=2_"^"_1
 ....;
 ....;
 ....;
 ....;
 .E  D
 ..S RY=3_"^"_3  ; MEANS NO REMINDER DIALOG FOUND
 E  D
 .S RY=3_"^"_2  ; MEANS NO ALERT TRACKING FILE ENTRY FOUND FOR THIS TYPE OF ALERT 
 Q
LKPORDCK(RY,ZP) ;Do a lookup for specific critical alert TYPE, and associated date/time of a real unacknowledged alert,and RETURN list of 
 ;any ORDERS by ordering provider user (DUZ) that have been made from list of available FAT (Follow-up Alert Tracking) orders in in specifi defined VEFA ALERT TRACKING entry's Reminder Dialog 
 ; multiples(and fields)with a Reminder Dialog, the dialog elements thereof containing the ORDER types (orderable iems) for such list 
 ;to be compared with any actual orders by ordering provider user(s) (DUZ) made after the date/time of the actual critical alert UP to NOW or
 ;to date of acknowledgement(deletion) OR now time (if not passed). Do this search in reverse chronological order.
 ;First Verify also that type of alert passed is in VEFA ALERT TRACKING file for "followup" purposes, and has defined REMINDER DIALOG
 ; INPUT 
 ;  ZP = DFN ^ DUZ ^ TYPE OF ALERT ^ DATE/TIME OF UNACK CRIT ALERT ^ DATE ACKNOWLEDGED(DELETED) 
 ; RETURN
 ;  RY= PROVIDER FOR ORDERS/FOLLOW-UPS  & THEN CONCATENATED STRING OF ACTUAL ORDERS MADE EACH SPEARATED WITH ";"
 ;
 ;
 N VEFADFN,VEFADUZ,VEFAALRT,VEFAADTT,VEFARMDL
 N VEFACNT,VEFACNT1,VEFACNT2
 N DISABLE,REMDIALG,DIALOGTY,DIALOGEL,RESOLTYP,ORDRITM,COUNTER,CNTORD,CNT1,ORDER,CNTTIMO,CNTTIMA,REVERST,CNTPAT,ORDERCK,COUNTERF
 N RYY,ACTION,ACTIONK,SIGSTAT
 N DELETEDT,ORDRITEM
 N FOLLUPCT,FOLLOWAC
 N VHEALTH,OVERFLAG,VHEALF,FOLLOWUP,VISITPTR
 N FOLLOWU1
 N AGENTPRM,AGENTPRV,COUNTER1,ACTIVE
 N INITDATE
 ;K RY
 S RY=0
 S AGENTPRV=""
 S COUNTER=0
 S COUNTER1=0
 K ^TMP($J,"ORDERITEM")
 K ^TMP($J,"FOLLOWUPITEM")
 K ^TMP($J,"ORDERITEMFOUND")
 S VEFADFN=$P(ZP,U,1) S VEFADUZ=$P(ZP,U,2) S VEFAALRT=$P(ZP,U,3) S VEFAADTT=$P(ZP,U,4) S DELETEDT=$P(ZP,U,5)
 ;
 ;first CHECK if type of alert if in VEFA ALERT TRACKING file
 S VEFACNT=0
 ;
 S VEFACNT=$O(^DIZ(19007,"B",VEFAALRT,VEFACNT))
 S ACTIVE=0
 S INITDATE=0
 ;CHECK IF ACTIVE
 ;S VEFACNT=$O(^DIZ(19007,"B",VEFAALRT,VEFACNT))
 I VEFACNT'="" D
 .S ACTIVE=$P($G(^DIZ(19007,VEFACNT,3)),"^",5)
 .I ACTIVE="" S ACTIVE=0
 .S INITDATE=$P($G(^DIZ(19007,VEFACNT,3)),"^",4)
 .I INITDATE="" S INITDATE=0
 ;I (VEFACNT'="")&(ACTIVE) D
 I (VEFACNT'="")&(INITDATE'=0) D
 .;
 .; RECORD # in VEFA TRACKED ALERTS file
 .; get reminder dialog 
 .S VEFARMDL=$P($G(^DIZ(19007,VEFACNT,3)),U,1) ;
 .I VEFARMDL'="" D
 ..;
 ..;GO TO FILE 801.41
 ..;CHECK IF DISABLED
 ..S DISABLE=$P($G(^PXRMD(801.41,VEFARMDL,0)),U,3)
 ..I (DISABLE=0)!(DISABLE="") D
 ...;
 ...;CHECK REMINDER TYPE AS "REMINDER DIALOG"
 ...S REMTYPE=$P($G(^PXRMD(801.41,VEFARMDL,0)),U,4)
 ...I REMTYPE="R" D
 ....;
 ....; LOOK THROUGH DIALOG GROUPS AND THEIR ELEMENTS TO FIND ORDERABLE ANY ORDER ITEMS.
 ....S VEFACNT=0
 ....F  S VEFACNT=$O(^PXRMD(801.41,VEFARMDL,10,"B",VEFACNT)) Q:VEFACNT=""  D
 .....;GET INTERNAL ENTRY #
 .....S VEFACNT1=0
 .....S VEFACNT1=$O(^PXRMD(801.41,VEFARMDL,10,"B",VEFACNT,VEFACNT1))
 .....;
 .....I VEFACNT1'="" D
 ......; GET DIALOG GROUP OR DIRECT DIALOG ELEMENT (ASSUME FOR NOW ONLY DIALOG GROUP WITH ORDERS)
 ......S REMDIALG=$P($G(^PXRMD(801.41,VEFARMDL,10,VEFACNT1,0)),U,2)
 ......;
 ......I REMDIALG'="" D
 .......; CHECK IF DIALOG GROUP
 .......S DIALOGTY=$P($G(^PXRMD(801.41,REMDIALG,0)),U,4)
 .......I DIALOGTY="G" D   ; DIALOG GROUP
 ........;
 ........S VEFACNT2=0 ; GET DIALOG ELEMENTS INSIDE THIS DIALOG GROUP
 ........F  S VEFACNT2=$O(^PXRMD(801.41,REMDIALG,10,"B",VEFACNT2)) Q:VEFACNT2=""  D
 .........;GET INTERNAL ENTRY #
 .........S DIALOGEL=0
 .........S DIALOGEL=$O(^PXRMD(801.41,REMDIALG,10,"B",VEFACNT2,DIALOGEL))
 .........; DIALOG ELEMENT
 .........;
 .........S DIALOGEL=$P($G(^PXRMD(801.41,REMDIALG,10,DIALOGEL,0)),U,2)
 .........;
 .........;CHECK "ORDER" RESOLUTION TYPE FIRST
 .........S RESOLTYP=$P($G(^PXRMD(801.41,DIALOGEL,1)),U,3)
 .........I RESOLTYP=3 D
 ..........;GET ORDERABLE ITEMS FILE ENTRY AS POOSIBLE FOLLOW-UP ACTION CHOICE. STORE INTO ^TMP($J,"ORDERITEM,COUNTER) ARRAY
 ..........S ORDERITEM=$P($G(^PXRMD(801.41,DIALOGEL,1)),U,7)
 ..........; NOW LOOK AT ORDERS IF ANY AND CHECK DATE/TIME > DATE/TIME OF PASSED CRIT ALERT
 ..........S COUNTER=COUNTER+1
 ..........;
 ..........S ^TMP($J,"ORDERITEM",COUNTER)=ORDERITEM
 ..........;new section to allow health factor to resolve with non-specific orderable item (like anti-biotics in general)
 ..........S FOLLUPCT=0
 ..........F  S FOLLUPCT=$O(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT)) Q:(FOLLUPCT="")!(FOLLUPCT="B")  D
 ...........S FOLLOWAC=$P($G(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT,0)),"^",1)  ;DYNAMIC POINTER
 ...........;LOOK FOR V HEALTH FACTOR TYPE ONLY
 ...........;GET FOLLOUP ACTION HEALTH FACTOR AS ADDITIONAL FINDING TYPE IN FORM "500156;AUTTHF(" WHERE NUMERIC LIKE 500156 IS INTERNAL # FOR HEALTH FACTOR ENTRY
 ...........I FOLLOWAC["AUTTHF(" D
 ............S COUNTER1=COUNTER1+1
 ............S ^TMP($J,"FOLLOWUPITEM",COUNTER1)=FOLLOWAC
 ..........;end section
 .........E  D
 ..........S FOLLUPCT=0
 ..........F  S FOLLUPCT=$O(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT)) Q:(FOLLUPCT="")!(FOLLUPCT="B")  D
 ...........S FOLLOWAC=$P($G(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT,0)),"^",1)  ;DYNAMIC POINTER
 ...........;LOOK FOR V HEALTH FACTOR TYPE ONLY
 ...........;GET FOLLOUP ACTION HEALTH FACTOR AS ADDITIONAL FINDING TYPE IN FORM "500156;AUTTHF(" WHERE NUMERIC LIKE 500156 IS INTERNAL # FOR HEALTH FACTOR ENTRY
 ...........I FOLLOWAC["AUTTHF(" D
 ............S COUNTER1=COUNTER1+1
 ............S ^TMP($J,"FOLLOWUPITEM",COUNTER1)=FOLLOWAC
 ....;  NOW GET ORDERS BY PATIENT AND PROVIDER (DUZ) DOESN'T CARE AS ORDER COULD BE MADE AMONG ANY PROVIDER IN OE/RR GROUP DEFINED
 ....; 
 ....; FOR SPECIFIC CRIT ALERT PROCESSING.BUT SHOULD MOST LIKELY BE MADE BY ORDERING PROVIDER. GET ORDERS STARTING IN REVERSE TIME
 ....; ORDER UNTIL DATE/TIME OF ANY ORDER < 
 ....;DATE/TIME OF CRIT ALERT,OR NO ORDER FOUND IS ENCOUNTERED. SEARCH AMONG ORDERITEM LIST F FOUND BEFORE END OF SEARCH IS OVER.
 ....;GO BY PATIENT FIRST
 ....S CNTTIMO=0  ; DATE/TIME OF ORDER ABD CNTTIMA DATE/TIME OF UNACK CRIT ALERT
 ....S CNTPAT=VEFADFN_";DPT("
 ....;
 ....;W !
 ....;ZW ^TMP($J,"ORDERITEM")
 ....;S COUNTERF=0  ; COUNTER OF ORDERS FOUND
 ....F  S CNTTIMO=$O(^OR(100,"AC",CNTPAT,CNTTIMO)) S REVERST=9999999-CNTTIMO Q:(CNTTIMO="")!(VEFAADTT>REVERST)  D
 .....;CHECK ONLY IS LESS THAN DELETED DATE/TIME IF PASSED
 .....I DELETEDT'="" I '(REVERST<DELETEDT) Q
 .....I VEFAADTT>REVERST Q
 .....S ORDER=0
 .....S ORDER=$O(^OR(100,"AC",CNTPAT,CNTTIMO,ORDER))
 .....;
 .....;
 .....I ORDER'="" D
 ......;S AGENTPRM=$P($G(^OR(100,D0,0)),"^",4) ; MAYBE PROVIDER
 ......S CNT1=0  ; SEARCH MULTIPLE ORDERABLE ITEMS WITHIN 1 ORDER
 ......F  S CNT1=$O(^OR(100,ORDER,.1,"B",CNT1)) Q:(CNT1="")  D
 .......S CNTORD=CNT1
 .......;
 .......;S CNTORD=$P($G(^OR(100,ORDER,.1,CNT1,0)),"^",1)
 .......;CHECK AMONG ALL ACTUAL ORDERABLE ITEMS OF ORDER AMONG LIST OF ORDERABLE ITEMS FOR FOLLOW-UP ACTION.LIST ONLY ONE OCCURENCE IN ARRAY
 .......S COUNTER=0
 .......F  S COUNTER=$O(^TMP($J,"ORDERITEM",COUNTER)) Q:COUNTER=""  D
 ........S ORDERCK=$G(^TMP($J,"ORDERITEM",COUNTER))
 ........;
 ........I ORDERCK=CNTORD D
 .........;S AGENTPRV=$P($G(^OR(100,D0,0)),"^",4) ; ACTUAL AGENT PROVIDER OF ORDER
 .........S RYY=2  ; FOUND
 .........;ORDERABLE ITEM NAME
 .........I ORDERCK'="" D
 ..........S ORDRITEM=$P($G(^ORD(101.43,ORDERCK,0)),"^",1)
 ..........S ^TMP($J,"ORDERITEMFOUND",ORDRITEM)=""
 ..........I ($P($G(^OR(100,ORDER,0)),"^",4)'="")&(AGENTPRV="") S AGENTPRV=$P($G(^OR(100,ORDER,0)),"^",4) ; ACTUAL AGENT PROVIDER OF ORDER
 ..........;W !,"AGENTPRV=",AGENTPRV
 .........S SIGSTAT=1
 .........;NOT CHECK IF SIGNATURE REQUIRED AND SIGNATURE ITSELF
 .........I $P($G(^OR(100,ORDER,0)),"^",16)=2 D      ;ORES
 ..........S ACTION=0
 ..........S SIGSTAT=0
 ..........F  S ACTION=$O(^OR(100,ORDER,8,ACTION)) Q:(ACTION="")!(ACTION="C")  D
 ...........S ACTIONK=ACTION
 ...........S SIGSTAT=$P($G(^OR(100,ORDER,8,ACTION,0)),"^",4)
 ..........; CHECK FOR SIG STAT=1 FOR SIGNED ORDER ("ELECTRONIC") 
 ..........I RY'[1 S RY=RYY_"^"_SIGSTAT  ;SIGSTAT = 1 MEANS NO SIG REQUIRED OR SIG REQUIRED AND FOUND 
 .........E  D
 ..........S RY=RYY_"^"_1
 .........;
 ......;
 ......I RY'=0 I RY'[1 S RY=0_"^"_3      ; IE. IF RY NOT= 2_"^"_1 S RY=0_"^"_3
 ....;
 ....D
 .....;
 .....;  NOW GET V HEALTH FACTORS BY PATIENT 
 .....; FOR SPECIFIC CRIT ALERT PROCESSING.GET V HEALTH FACTORS STARTING IN REVERSE TIME ORDER 
 .....;UNTIL DATE/TIME OF ANY FOLLOWUP ACTION (V HEALTH FACTOR)< 
 .....;DATE/TIME OF CRIT ALERT,OR NO V  HEALTH FACTOR FOUND IS ENCOUNTERED. SEARCH AMONG FOLLOWUP LIST FOUND BEFORE END OF SEARCH IS OVER.
 .....;GO BY PATIENT FIRST
 .....S VHEALTH=999999999999
 .....S OVERFLAG=0
 .....;W !
 .....;ZW ^TMP($J,"FOLLOWUPITEM")
 .....F  S VHEALTH=$O(^AUPNVHF("C",VEFADFN,VHEALTH),-1) Q:(VHEALTH="")!(OVERFLAG=1)  D
 ......S VISITPTR=$P($G(^AUPNVHF(VHEALTH,0)),"^",3)
 ......I VISITPTR'="" S REVERST=$P($G(^AUPNVSIT(VISITPTR,0)),"^",1)
 ......;
 ......;
 ......I VEFAADTT>REVERST S OVERFLAG=1 Q
 ......I DELETEDT'="" I '(REVERST<DELETEDT) Q
 ......S VHEALFT=$P($G(^AUPNVHF(VHEALTH,0)),"^",1)
 ......;;;;;I VHEALFT=500158 S ^XTMP("AAA4","500158")=VEFADFN_"^"_VHEALTH
 ......;CHECK IF THIS HEALTH FACTOR WITHIN DATE/TIME ALLOWED IS ONE OF FOLLOWUP ACTION HEALTH FACTORS
 ......S COUNTER1=0
 ......F  S COUNTER1=$O(^TMP($J,"FOLLOWUPITEM",COUNTER1)) Q:(COUNTER1="")  D
 .......S FOLLOWUP=$G(^TMP($J,"FOLLOWUPITEM",COUNTER1))
 .......;S ^XTMP("AAAA",COUNTER1)=FOLLOWUP_"^"_VHEALFT
 .......I FOLLOWUP[VHEALFT D
 ........S FOLLOWU1=$P(FOLLOWUP,";",1)
 ........I FOLLOWU1'="" D
 .........S FOLLOWU1=$P($G(^AUTTHF(FOLLOWU1,0)),"^",1)
 .........I ($P($G(^AUPNVHF(VHEALTH,12)),"^",4)'="")&(AGENTPRV="") S AGENTPRV=$P($G(^AUPNVHF(VHEALTH,12)),"^",4) ;
 .........;W !,"AGENTPRV=",AGENTPRV
 .........S ^TMP($J,"ORDERITEMFOUND",FOLLOWU1)=""   ; S RY=2_"^"_1
 ....;
 ....;
 ....;
 ....;
 .E  D
 ..S RY=3_"^"_3  ; MEANS NO REMINDER DIALOG FOUND
 E  D
 .S RY=3_"^"_2  ; MEANS NO ALERT TRACKING FILE ENTRY FOUND FOR THIS TYPE OF ALERT 
 ;DO LOOP OF ORDERS FOUND RETURNED CONCATENATED WITH ";"
 S RY=""
 S RY=AGENTPRV_";"
 S COUNTERF=0
 F  S COUNTERF=$O(^TMP($J,"ORDERITEMFOUND",COUNTERF)) Q:COUNTERF=""  D
 .S RY=RY_COUNTERF_";"
 Q
]]></Routine>
</Export>
