<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25" zv="Cache for UNIX (Red Hat Enterprise Linux 5 for x86-64) 2011.1.2 (Build 701)" ts="2014-04-25 16:35:38">
<Routine name="VEFAALR1" type="INT" languagemode="0" timestamp="63270,67092.353794"><![CDATA[
VEFAALR1 ;IHV/VEFA - Module 2 for CPRS COM OBJECT [ 12/01/2010 ]
 ;;1.0;VEFA;**1**;1-MAY-11;Build 17
IMAGEGEN ;
 N PATIEN,ALERTID,DATETIME,ORDERPRV,MSGTEXT1,LAST4,LENGTH,NEWALERT,ACTIONFLG,ENTRYPNT,AROUTINE,DELWOPRC,DAYSSURG,DAYSSUPV,DAYSBREV,DATAALR
 N DATAALRT,PATIENT,FILE
 N RADIOLO,RETENTD,ALERTIDN,RECIPINT,RECIPTYP,EXIT,X1,X2,Y
 K FDA,FDAIEN,OROUT
REP1 S DIC=2,DIC(0)="QAEZ" K DIC("A") S DIC("A")="Select Patient for Imaging Alert : " D ^DIC
 I X="^" Q
 I Y=-1 G REP1
 ;
 ; ALERT FILE FIRST
 ;
 ;
 S PATIEN=$P(Y,"^",1) ; 
 D NOW^%DTC S DATETIME=%
 S X1=%,X2=14 D C^%DTC S RETENTD=X
 S LAST4=$E($P($G(^DPT(PATIEN,0)),"^",9),6,9)
 ;
 ; FOR NOW NO QUESTION ON ORDERING PROVIDER. ASSUMED `1 AS PROGRAMMER,ONE
 S ORDERPRV=1 ; ARTIFICIAL 2ND RECIPIENT AFTER RADIOLOGIST,ONE (11716) BELOW
 W !!
 W "Provider Selection:"
 K LRSRNB
 D ALSP("Providers with ORES key^Provider","^VA(200,",.LRSRNB)
 I LRSRNB["^" Q
 N IENN
 ;ZW LRSRNB
 S IENN=0
 F  S IENN=$O(LRSRNB(IENN)) Q:IENN=""  D
 .S ORDERPRV=IENN
 S RADIOLO=DUZ ; 11716
 S ALERTID="OR,"_PATIEN_",25;"_ORDERPRV_";"_DATETIME
 S MSGTEXT1=$G(^DPT(PATIEN,0))
 ;W !,MSGTEXT1
 S MSGTEXT1=$E(MSGTEXT1,1,9)
 ;W !,MSGTEXT1
 ;   $E($P($G(^DPT(PATIEN,0)),"^",1),1,9)
 S MSGTEXT1=MSGTEXT1_" ("
 ;   _" ("
 S MSGTEXT1=MSGTEXT1_$E($P($G(^DPT(PATIEN,0)),"^",1),1,1)
 S EXIT=1
 S MSGTEXT1=MSGTEXT1_LAST4_"): Abnl Imaging Reslt, Needs Attn: "
 W !!,"DO YOU WANT CHEST 2 VIEWS PA&LAT" S %=1 D YN^DICN I %=1 D
 .S MSGTEXT1=MSGTEXT1_"CHEST 2 VIEWS PA&LAT" S EXIT=0
 I EXIT=0 G OVER
 W !!,"DO YOU WANT MAMMOGRAM BILAT" S %=1 D YN^DICN I %=1 D
 .S MSGTEXT1=MSGTEXT1_"MAMMOGRAM" S EXIT=0
 .;S MSGTEXT1=MSGTEXT1_"MAMM BI2V" S EXIT=0
OVER I EXIT=1 K % Q
 K %
 S LENGTH=$L(MSGTEXT1)
 I LENGTH>60 S MSGTEXT1=$E(MSGTEXT1,1,60)  ; W !,"OVER"
 S NEWALERT=1
 S ACTIONFLG="R"
 S ENTRYPNT="RPTRAD2"
 S AROUTINE="ORB3FUP2"
 S DELWOPRC=1 ; CAN DELETE W/O PROCESSING
 S DAYSSURG=1
 S DAYSSUPV=1
 S DAYSBREV=1
 S DATAALRT="6919591.9099~1"
 S PATIENT=$P($G(^DPT(PATIEN,0)),"^",1)
 S FDAIEN(1)=ORDERPRV
 S FILE=8992.01
 S FDA(44,FILE,"?+2,"_FDAIEN(1)_",",.01)=DATETIME
 S FDA(44,FILE,"?+2,"_FDAIEN(1)_",",.02)=ALERTID
 S FDA(44,FILE,"?+2,"_FDAIEN(1)_",",.03)=MSGTEXT1
 S FDA(44,FILE,"?+2,"_FDAIEN(1)_",",.04)=NEWALERT
 S FDA(44,FILE,"?+2,"_FDAIEN(1)_",",.05)=ACTIONFLG
 S FDA(44,FILE,"?+2,"_FDAIEN(1)_",",.07)=ENTRYPNT
 S FDA(44,FILE,"?+2,"_FDAIEN(1)_",",.08)=AROUTINE
 S FDA(44,FILE,"?+2,"_FDAIEN(1)_",",.1)=DELWOPRC
 S FDA(44,FILE,"?+2,"_FDAIEN(1)_",",.13)=DAYSSURG
 S FDA(44,FILE,"?+2,"_FDAIEN(1)_",",.14)=DAYSSUPV
 S FDA(44,FILE,"?+2,"_FDAIEN(1)_",",.15)=DAYSBREV
 S FDA(44,FILE,"?+2,"_FDAIEN(1)_",",1)=DATAALRT
 S FDA(44,FILE,"?+2,"_FDAIEN(1)_",",3.02)=PATIEN
 ;W !,MSGTEXT1
 ;Q
 D UPDATE^DIE("","FDA(44)","FDAIEN","OROUT(44)")
 I $D(OROUT(44,"DIERR")) W !,"DATE/TIME ERROR= ",DATETIME," ",OROUT(44,"DIERR",1,"TEXT",1) Q
 K FDA(44),OROUT(44)
 ;Q
 ;
 ; ALERT TRACKING FILE NOW
 ;
 ;
 ;S PKKID="OR,25"
 ;S DISPTXT=MSGTEXT1
 ;DATETIME
 ;ALERTID
 ;FIRST RECEIPIENT IS RADIOLOGIST,TWO
 ;S GENERBY=11716
 K FDA,FDAIEN,OROUT
 S FILE=8992.1
 S FDA(45,FILE,"?+1,",.01)=ALERTID   ;NAME ALERTID
 S FDA(45,FILE,"?+1,",.02)=DATETIME  ; DATE CREATED
 S FDA(45,FILE,"?+1,",.03)="OR,"_25   ; PKG ID
 S FDA(45,FILE,"?+1,",.04)=PATIEN     ; PATIENT
 S FDA(45,FILE,"?+1,",.05)=RADIOLO   ;GENERATED BY (RADIOLOGIST)
 S FDA(45,FILE,"?+1,",.06)=1         ; GENERATED WHILE QUEUED
 S FDA(45,FILE,"?+1,",.08)=RETENTD   ; RETENTION DATE
 S FDA(45,FILE,"?+1,",1.01)=MSGTEXT1     ; DISPLAY TEXT
 S FDA(45,FILE,"?+1,",1.03)=ENTRYPNT   ;ROUTINE TAG
 S FDA(45,FILE,"?+1,",1.04)=AROUTINE   ; ROUTINE FOR PROCESSING
 S FDA(45,FILE,"?+1,",2)=DATAALRT   ; DATA FOR ALERT
 D UPDATE^DIE("","FDA(45)","FDAIEN","OROUT(45)")
 I $D(OROUT(45,"DIERR")) W !,"NAME ALERTID ERROR= ",ALERTID," ",OROUT(45,"DIERR",1,"TEXT",1) Q
 S ALERTIDN=FDAIEN(1)
 K FDA(45),OROUT(45)
 K FDA,FDAIEN,OROUT
 S FILE=8992.11 ; RECIPIENT MULTIPLE
 S FDAIEN(1)=ALERTIDN
 ;RECIPIENT , FIRST PROGRAMMER,ONE AS ORDERING PROVIDER AS"INITIAL RECIPIENT" AS RECIPIENT TYPE
 S FDA(46,FILE,"?+2,"_FDAIEN(1)_",",.01)=ORDERPRV
 ;//S FDA(46,FILE,"?+2,"_FDAIEN(1)_",",.02)=DATETIME  ; ALERT FIRST DISPLAYED
 D UPDATE^DIE("","FDA(46)","FDAIEN","OROUT(46)")
 I $D(OROUT(46,"DIERR")) W !,"RECIPIENT ERROR= ",ORDERPRV," ",OROUT(46,"DIERR",1,"TEXT",1) Q
 S RECIPINT=FDAIEN(2)
 K FDA(46),OROUT(46)
 ; SUB FILE ENTRY RECIPIENT TYPE 
 K FDA,FDAIEN,OROUT
 S FILE=8992.111  ; RECIPIENT TYPE MULTIPLE
 S FDAIEN(1)=ALERTIDN
 S FDAIEN(2)=RECIPINT
 S RECIPTYP=1  ; INITIAL RECIPIENT
 ;RECIPIENT , FIRST PROGRAMMER,ONE AS ORDERING PROVIDER AS"INITIAL RECIPIENT" AS RECIPIENT TYPE
 S FDA(47,FILE,"?+3,"_FDAIEN(2)_","_FDAIEN(1)_",",.01)=RECIPTYP   ; RECIPIENT TYPE
 S FDA(47,FILE,"?+3,"_FDAIEN(2)_","_FDAIEN(1)_",",.04)=DATETIME  ; ALERT DATE/TIME
 D UPDATE^DIE("","FDA(47)","FDAIEN","OROUT(47)")
 I $D(OROUT(47,"DIERR")) W !,"RECIPIENT TYPE ERROR= ",DATETIME," ",OROUT(47,"DIERR",1,"TEXT",1) Q
 K FDA(47),OROUT(47)
 Q
LOOKUP(RY,ZP) ;Do a lookup for a VEFA Tracked Critical Alert AND check if pointing to passd class in VEFA CRITICAL ALERT CATEGORY (in FILE (19008))
 ;;
 ; ZP = TYPE OF ALERT  ^ CLASS OF ALERT
 ; RY = 1 IF UNACKNOWLEDGED TYPE ALERT DEFINED
 ;
 K RY
 ;S RY="ASX" Q
 N VEFAVAL,VEFACLAS,VEFCIEN,VEFAPCL,VEFAALRT,VEFACIEN
 S VEFAALRT=$P(ZP,U,1) ;Type of Alert being looked up.
 S VEFACLAS=$P(ZP,U,2)
 S VEFAVAL=0
 S VEFAVAL=$O(^DIZ(19007,"B",VEFAALRT,VEFAVAL))
 I VEFAVAL'="" D
 .;CHECK VEFA CRITICAL ALERT CATEGORY FILE ENTRY.
 .;COMPARE TO PASSED ALERT CATEGORY
 .;get class passed IEN
 .S VEFACIEN=0
 .S VEFACIEN=$O(^DIZ(19008,"B",VEFACLAS,VEFACIEN))
 .;GET POINTED TO CLASS OF VEFA ALERT (VEFAPCL)
 .S VEFAPCL=$P($G(^DIZ(19007,VEFAVAL,3)),"^",3)
 .;S ^XTMP("VEFAPCL")=VEFAPCL_"^"_VEFACIEN
 .I VEFAPCL'=VEFACIEN S VEFAVAL=0  ; NOT MATCH
 E  D
 .S VEFAVAL=0
 S RY=VEFAVAL
 Q
CAT(X) ;D0 AS X
 N VEFACNT,VEFACAT,VEFANOTF,VEFACATY,VEFAALNT,VEFADSPL,VEFACATN,VEFAUTCA,VEFAENTR,VEFANAME,VEFAACTV,VEFAALDT
 N D0
 S D0=X
 S VEFACATY=0  ; NOT CATEGORY CLASS
 ;GET NOTIFICATION TYPE FOR THIS ALERT
 S VEFAALNT=$P($P($P($G(^XTV(8992.1,D0,0)),"^",1),";",1),",",3)
 ;GET DATE CREATED
 S VEFAALDT=$P($G(^XTV(8992.1,D0,0)),"^",2)
 ;GET DISPLAY EXT THIS TYPE OF ALERT
 S VEFADSPL=$P($G(^XTV(8992.1,D0,1)),"^",1)
 S VEFACAT=0
 F  S VEFACAT=$O(^DIZ(19008,"B",VEFACAT)) Q:VEFACAT=""  D
 .S VEFACNT=0
 .S VEFACNT=$O(^DIZ(19008,"B",VEFACAT,VEFACNT)) D
 ..;GET NOTIFICATION TYPE
 ..S VEFANOTF=$P($G(^DIZ(19008,VEFACNT,1)),"^",2)
 ..I VEFANOTF=VEFAALNT D
 ...I VEFACATY'=1 S VEFACATY=2
 ...S VEFACATN=$P($G(^DIZ(19008,VEFACNT,0)),"^",1)
 ...I VEFADSPL[VEFACATN D
 ....I VEFACATY'=1 S VEFACATY=3
 ....; LOOP THROUGH UNIQUE VEFA TRACKED CRITICAL ALERTS
 ....S VEFAUTCA=0
 ....F  S VEFAUTCA=$O(^DIZ(19007,"B",VEFAUTCA)) Q:VEFAUTCA=""  D
 .....;GET ENTRY
 .....S VEFAENTR=0
 .....S VEFAENTR=$O(^DIZ(19007,"B",VEFAUTCA,VEFAENTR))
 .....S VEFANAME=$P(^DIZ(19007,VEFAENTR,0),"^",1)
 .....S VEFAACTV=$P(^DIZ(19007,VEFAENTR,3),"^",4) ;ACTIVATION DATE OF SPECIFIC ALERT TYPE
 .....I (VEFADSPL[VEFANAME)&('(VEFAALDT<VEFAACTV)) S VEFACATY=1
 .....;W !,"VEFADSPL=",VEFADSPL," VEFAALDT=",VEFAALDT," VEFAACTV=",VEFAACTV,"VEFACATY=",VEFACATY
 I (VEFACATY=2)!(VEFACATY=3) S VEFACATY=0
 Q VEFACATY
SERVICE(X) ;
 ;RETURN SERVICE LINE OF INITIAL RECEIPIENT PROVIDER'S SERVICE LINE
 N VEFCNT,D0,VEFAPRV,VEFASYS,VEFAPRV1,VEFAPRV2,VEFALIST,VEFAPRV3,VEFAPRV4,VEFASYSS,PATIENT,ALERTID,PATIENT1
 N FACNAME,DEFALINS
 S D0=X
 S VEFAPRV=0
 S VEFASYS="NUL"
 S VEFAPRV1="NUL"
 S VEFALIST=""
 S PATIENT=""
 ;F  S VEFAPRV=$O(^XTV(8992.1,D0,20,"B",VEFAPRV)) Q:(VEFAPRV="")!(VEFASYS'="NUL")  D
 F  S VEFAPRV=$O(^XTV(8992.1,D0,20,"B",VEFAPRV)) Q:(VEFAPRV="")  D
 .S VEFACNT=0
 .S VEFACNT=$O(^XTV(8992.1,D0,20,"B",VEFAPRV,VEFACNT)) I VEFACNT=1 D
 ..;TAKE FIRST "INITIAL RECIPIENT" TYPE AS ASSUMED ORDERING PROVIDER. COULD BE OTHERS INCLUDING LAB TECH, RADIOLOGIST, AND OE/RR TEAMS
 ..;GET SERVICE LINE (CLINIC) 
 ..S VEFAPRV2=$P($G(^XTV(8992.1,D0,20,VEFACNT,0)),"^",1)
 ..I VEFAPRV2'="" D
 ...S VEFASYS=$P($G(^VA(200,VEFAPRV2,5)),"^",1)
 ...S VEFAPRV1=$P($G(^VA(200,VEFAPRV2,0)),"^",1)
 ...S VEFAPRV1=VEFAPRV1_" - "_VEFAPRV2
 ...;CORRECT ORDERING PROVIDER
 ...;GET ORDER FOR LAB ORDERS. TAKE AS IS FOR IMAGING ORDER FOR NOW
 ...S ORDER=$P($G(^XTV(8992.1,D0,2)),"@",1)
 ...I (ORDER'["~")&(ORDER'="") D
 ....;GET ORDERING PROVIDER FROM ORDER
 ....S VEFAPRV2=$P($G(^OR(100,ORDER,0)),"^",4)
 ....S VEFAPRV1=$P($G(^VA(200,VEFAPRV2,0)),"^",1)
 ....S VEFAPRV1=VEFAPRV1_" - "_VEFAPRV2
 ..I VEFASYS'="" D
 ...S VEFASYS=$P($G(^DIC(49,VEFASYS,0)),"^",1)
 ..E  D
 ...S VEFASYS="NUL"
 .;
 .S PATIENT1=""
 .S PATIENT=$P($G(^XTV(8992.1,D0,0)),"^",4)
 .I PATIENT'="" S PATIENT1=$P($G(^DPT(PATIENT,0)),"^",1)
 .S PATIENT1=PATIENT
 .S ALERTID=$P($G(^XTV(8992.1,D0,0)),"^",1)
 .;
 .D
 ..;TAKE FIRST "INITIAL RECIPIENT" TYPE AS ASSUMED ORDERING PROVIDER. COULD BE OTHERS INCLUDING LAB TECH, RADIOLOGIST, AND OE/RR TEAMS
 ..;GET SERVICE LINE (CLINIC) 
 ..S VEFAPRV4=$P($G(^XTV(8992.1,D0,20,VEFACNT,0)),"^",1)
 ..I VEFAPRV4'="" D
 ...S VEFASYSS=$P($G(^VA(200,VEFAPRV4,5)),"^",1)
 ...S VEFAPRV3=$P($G(^VA(200,VEFAPRV4,0)),"^",1)
 ..I VEFASYSS'="" D
 ...S VEFASYSS=$P($G(^DIC(49,VEFASYSS,0)),"^",1)
 ..E  D
 ...S VEFASYSS="NUL"
 ..S VEFALIST=VEFALIST_VEFAPRV3_" - "_VEFAPRV4_";"
 ;GET FACILITY NAME FROM INSTITUTION FROM KERENEL SYSTEM PARAMETERS 'S DEFAULT INSTITUTION
 S FACNAME=""
 S DEFALINS=$P($G(^XTV(8989.3,1,"XUS")),"^",17)
 I DEFALINS'="" S FACNAME=$P($G(^DIC(4,DEFALINS,99)),"^",3)
 Q ALERTID_"^"_FACNAME_"^"_VEFASYS_"^"_VEFAPRV1_"^"_VEFALIST_"^"_PATIENT1_"^"_$E($$ALERT(X),1,60)
SERVIC1(X) ;
 ;RETURN SERVICE LINE OF INITIAL RECEIPIENT PROVIDER'S SERVICE LINE
 N VEFCNT,D0,VEFAPRV,VEFASYS,VEFAPRV1,VEFAPRV2
 S D0=X
 S VEFAPRV=0
 S VEFASYS="NUL"
 S VEFAPRV1="NUL"
 F  S VEFAPRV=$O(^XTV(8992.1,D0,20,"B",VEFAPRV)) Q:(VEFAPRV="")!(VEFASYS'="NUL")  D
 .S VEFACNT=0
 .S VEFACNT=$O(^XTV(8992.1,D0,20,"B",VEFAPRV,VEFACNT)) I VEFACNT=1 D
 ..;TAKE FIRST "INITIAL RECIPIENT" TYPE AS ASSUMED ORDERING PROVIDER. COULD BE OTHERS INCLUDING LAB TECH, RADIOLOGIST, AND OE/RR TEAMS
 ..;GET SERVICE LINE (CLINIC) 
 ..S VEFAPRV2=$P($G(^XTV(8992.1,D0,20,VEFACNT,0)),"^",1)
 ..I VEFAPRV2'="" D
 ...S VEFASYS=$P($G(^VA(200,VEFAPRV2,5)),"^",1)
 ...S VEFAPRV1=$P($G(^VA(200,VEFAPRV2,0)),"^",1)
 ..I VEFASYS'="" D
 ...S VEFASYS=$P($G(^DIC(49,VEFASYS,0)),"^",1)
 ..E  D
 ...S VEFASYS="NUL"
 Q VEFASYS_"^"_VEFAPRV2_"^"_$E($$ALERT1(X),1,60)
STATUS(X) ;
 ;RETURN A RECIPINT'S UNACKNOWLEDGED STATUS^RENEW DATE^ACKNOWLEDGED OR DELETED DATE
 ;RENEW DATE MEANS NON-NULL PROCESSED DATE W/O DELETED DATE
 ;ACKNOWLEDGED DATE MEANS NON-NULL PROCESSED DATE AND DELETE DATE
 ;UNACKNOWLEDGED STATUS MEANS NULL PROCESSED DATE AND NULL DELETE DATE
 N VEFCNT,D0,VEFAPRV,VEFASYS,VEFAPRV1,VEFAPRV2,VEFAPROC,VEFADELE,VEFAOVER,VEFAENTR,VEFADATE,VEFADSPL,VEFADAT1,VEFALAST,VEFACNT2
 N VEFAPROV
 S D0=X
 S VEFAPRV=0
 S VEFADSPL=$P($G(^XTV(8992.1,D0,0)),"^",1)
 ;W !,"VEFADSPL=",VEFADSPL
 S VEFASYS="YES"  ; UNACKNOWLEDGED AS DEFAULT
 S VEFAOVER=0
 F  S VEFAPRV=$O(^XTV(8992.1,D0,20,"B",VEFAPRV)) Q:(VEFAPRV="")!(VEFAOVER=1)  D
 .S VEFACNT=0
 .S VEFACNT=$O(^XTV(8992.1,D0,20,"B",VEFAPRV,VEFACNT)) D
 ..;TAKE ALL "INITIAL RECIPIENT" TYPES AS ASSUMED ORDERING PROVIDER FIRST. COULD BE OTHERS INCLUDING LAB TECH, RADIOLOGIST, AND OE/RR TEAMS
 ..;GET SERVICE LINE (CLINIC) 
 ..S VEFAPRV2=$P($G(^XTV(8992.1,D0,20,VEFACNT,0)),"^",1)
 ..I VEFAPRV2'="" D
 ...;GET PROCESSED DATE
 ...S VEFAPROC=$P($G(^XTV(8992.1,D0,20,VEFACNT,0)),"^",4) I VEFAPROC'="" S Y=VEFAPROC X ^DD("DD") S VEFAPROC=Y
 ...;W !,VEFAPROC
 ...S VEFADELE=$P($G(^XTV(8992.1,D0,20,VEFACNT,0)),"^",5) I VEFADELE'="" S Y=VEFADELE X ^DD("DD") S VEFADELE=Y
 ...;W !,VEFADELE
 ...;CHECK IF REALLY DELETED OR JUST RENEWED. LOOK INTO DINUM ALERT FILE ENTRY FOR PROVIDER DOING PROCESSING/DELETING/RENEWING
 ...; ACTUALLY ALL RECIPIENTS SHOULD BE RENEWED INCLUDING FIRST INITIAL RECIPIENT AS ORDERING PROVIDER
 ...S VEFADATE=$P($P($G(^XTV(8992.1,D0,0)),"^",1),";",3)-.01
 ...S VEFAENTR=""
 ...;I $G(^XTV(8992,VEFAPRV2,"XQA",VEFADATE,0)) I $P($G(^XTV(8992,VEFAPRV2,"XQA",VEFADATE,0)),"^",2)=VEFADSPL S VEFAENTR=1 ;D1,0)
 ...;CHECK NEXT RECORD AS ONE MORE CHANCE SKIPPING OVER INFO ALERT IF STILL THERE TO CHECK :REAL' ALERT
 ...S VEFALAST=0
 ...S VEFACNT2=0
 ...F  S VEFADATE=$O(^XTV(8992,VEFAPRV2,"XQA",VEFADATE)) Q:(VEFALAST=1)!(VEFADATE="")  D
 ....;ADD .00000001
 ....;S VEFADAT1=VEFADATE+.00000001
 ....S VEFACNT2=VEFACNT2+1  ; CAN AT MOST BE 2
 ....;W !,VEFADAT1
 ....;W !,$G(^XTV(8992,VEFAPRV2,"XQA",VEFADAT1,0))
 ....;W !,VEFADSPL
 ....;W !,VEFAENTR
 ....;SOMETIMES HAS TO SKIP OVER ANY INFO ALERT
 ....I ($G(^XTV(8992,VEFAPRV2,"XQA",VEFADATE,0))) I $P($G(^XTV(8992,VEFAPRV2,"XQA",VEFADATE,0)),"^",2)=VEFADSPL D
 .....S VEFAENTR=1 ;D1,0
 .....I (VEFAPROC'="") S VEFADELE=""
 ....;.W !,VEFAENTR
 ....I VEFACNT2=2 I (VEFAENTR="")&(VEFADELE'="") S VEFAPROC=""
 ....I (VEFAPROC'="")!(VEFADELE'="") S VEFASYS="" S VEFAOVER=1
 ....I (VEFACNT2=1)&($P($G(^XTV(8992,VEFAPRV2,"XQA",VEFADATE,0)),"^",2)=VEFADSPL) S VEFALAST=1
 ....I (VEFACNT2=2) S VEFALAST=1
 S VEFAPROV=""  ; PROVIDER
 I (VEFAPROC'="")!(VEFADELE'="") D
 .; DINUM PROVIDER IN ALERT FILE TO NEW PERSON FILE
 .I VEFAPRV2'="" S VEFAPROV=$P($G(^VA(200,VEFAPRV2,0)),"^",1)_" - "_VEFAPRV2
 Q VEFASYS_"^"_VEFAPROC_"^"_VEFADELE_"^"_VEFAPROV
STATUS1(X) ;
 ;RETURN A RECIPINT'S UNACKNOWLEDGED STATUS^RENEW DATE^ACKNOWLEDGED OR DELETED DATE
 ;RENEW DATE MEANS NON-NULL PROCESSED DATE W/O DELETED DATE
 ;ACKNOWLEDGED DATE MEANS NON-NULL PROCESSED DATE AND DELETE DATE
 ;UNACKNOWLEDGED STATUS MEANS NULL PROCESSED DATE AND NULL DELETE DATE
 N VEFCNT,D0,VEFAPRV,VEFASYS,VEFAPRV1,VEFAPRV2,VEFAPROC,VEFADELE,VEFAOVER,VEFAENTR,VEFADATE,VEFADSPL,VEFADAT1,VEFALAST,VEFACNT2
 N VEFADEL1 ; LINEAR TEMPSON TIME FOR COMPARISON IN SUBSEQUENT CALL
 S D0=X
 S VEFAPRV=0
 S VEFADSPL=$P($G(^XTV(8992.1,D0,0)),"^",1)
 ;W !,"VEFADSPL=",VEFADSPL
 S VEFASYS="YES"  ; UNACKNOWLEDGED AS DEFAULT
 S VEFAOVER=0
 F  S VEFAPRV=$O(^XTV(8992.1,D0,20,"B",VEFAPRV)) Q:(VEFAPRV="")!(VEFAOVER=1)  D
 .S VEFACNT=0
 .S VEFACNT=$O(^XTV(8992.1,D0,20,"B",VEFAPRV,VEFACNT)) D
 ..;TAKE ALL "INITIAL RECIPIENT" TYPES AS ASSUMED ORDERING PROVIDER FIRST. COULD BE OTHERS INCLUDING LAB TECH, RADIOLOGIST, AND OE/RR TEAMS
 ..;GET SERVICE LINE (CLINIC) 
 ..S VEFAPRV2=$P($G(^XTV(8992.1,D0,20,VEFACNT,0)),"^",1)
 ..I VEFAPRV2'="" D
 ...;GET PROCESSED DATE
 ...S VEFAPROC=$P($G(^XTV(8992.1,D0,20,VEFACNT,0)),"^",4) I VEFAPROC'="" S Y=VEFAPROC X ^DD("DD") S VEFAPROC=Y
 ...;W !,VEFAPROC
 ...S VEFADELE=$P($G(^XTV(8992.1,D0,20,VEFACNT,0)),"^",5) I VEFADELE'="" S VEFADEL1=VEFADELE S Y=VEFADELE X ^DD("DD") S VEFADELE=Y
 ...;W !,VEFADELE
 ...;CHECK IF REALLY DELETED OR JUST RENEWED. LOOK INTO DINUM ALERT FILE ENTRY FOR PROVIDER DOING PROCESSING/DELETING/RENEWING
 ...; ACTUALLY ALL RECIPIENTS SHOULD BE RENEWED INCLUDING FIRST INITIAL RECIPIENT AS ORDERING PROVIDER
 ...S VEFADATE=$P($P($G(^XTV(8992.1,D0,0)),"^",1),";",3)-.01
 ...S VEFAENTR=""
 ...;I $G(^XTV(8992,VEFAPRV2,"XQA",VEFADATE,0)) I $P($G(^XTV(8992,VEFAPRV2,"XQA",VEFADATE,0)),"^",2)=VEFADSPL S VEFAENTR=1 ;D1,0)
 ...;CHECK NEXT RECORD AS ONE MORE CHANCE SKIPPING OVER INFO ALERT IF STILL THERE TO CHECK :REAL' ALERT
 ...S VEFALAST=0
 ...S VEFACNT2=0
 ...F  S VEFADATE=$O(^XTV(8992,VEFAPRV2,"XQA",VEFADATE)) Q:(VEFALAST=1)!(VEFADATE="")  D
 ....;ADD .00000001
 ....;S VEFADAT1=VEFADATE+.00000001
 ....S VEFACNT2=VEFACNT2+1  ; CAN AT MOST BE 2
 ....;W !,VEFADAT1
 ....;W !,$G(^XTV(8992,VEFAPRV2,"XQA",VEFADAT1,0))
 ....;W !,VEFADSPL
 ....;W !,VEFAENTR
 ....;SOMETIMES HAS TO SKIP OVER ANY INFO ALERT
 ....I ($G(^XTV(8992,VEFAPRV2,"XQA",VEFADATE,0))) I $P($G(^XTV(8992,VEFAPRV2,"XQA",VEFADATE,0)),"^",2)=VEFADSPL D
 .....S VEFAENTR=1 ;D1,0
 .....I (VEFAPROC'="") S VEFADELE=""
    ....;.W !,VEFAENTR
 ....I VEFACNT2=2 I (VEFAENTR="")&(VEFADELE'="") S VEFAPROC=""
 ....I (VEFAPROC'="")!(VEFADELE'="") S VEFASYS="" S VEFAOVER=1
 ....I (VEFACNT2=1)&($P($G(^XTV(8992,VEFAPRV2,"XQA",VEFADATE,0)),"^",2)=VEFADSPL) S VEFALAST=1
 ....I (VEFACNT2=2) S VEFALAST=1
 I VEFADELE'="" D  ; CONVERT BACK TO LINEAR TIME
 .S VEFADELE=VEFADEL1
 E  D
 .S VEFADELE=""
 Q VEFASYS_"^"_VEFAPROC_"^"_VEFADELE
ALERT(X) ;D0 AS X
 N VEFACNT,VEFACAT,VEFANOTF,VEFACATY,VEFAALNT,VEFADSPL,VEFACATN,VEFAUTCA,VEFAENTR,VEFANAME
 N D0
 S D0=X
 S VEFACATN=""
 S VEFANAME=""
 S VEFACATY=0  ; NOT CATEGORY CLASS
 ;GET NOTIFICATION TYPE FOR THIS ALERT
 S VEFAALNT=$P($P($P($G(^XTV(8992.1,D0,0)),"^",1),";",1),",",3)
 ;GET DISPLAY EXT THIS TYPE OF ALERT
 S VEFADSPL=$P($G(^XTV(8992.1,D0,1)),"^",1)
 S VEFACAT=0
 F  S VEFACAT=$O(^DIZ(19008,"B",VEFACAT)) Q:(VEFACAT="")!(VEFACATY=1)  D
 .S VEFACNT=0
 .S VEFACNT=$O(^DIZ(19008,"B",VEFACAT,VEFACNT)) D
 ..;GET NOTIFICATION TYPE
 ..S VEFANOTF=$P($G(^DIZ(19008,VEFACNT,1)),"^",2)
 ..I VEFANOTF=VEFAALNT D
 ...I VEFACATY'=1 S VEFACATY=2
 ...S VEFACATN=$P($G(^DIZ(19008,VEFACNT,0)),"^",1)
 ...I VEFADSPL[VEFACATN D
 ....I VEFACATY'=1 S VEFACATY=3
 ....; LOOP THROUGH UNIQUE VEFA TRACKED CRITICAL ALERTS
 ....S VEFAUTCA=0
 ....F  S VEFAUTCA=$O(^DIZ(19007,"B",VEFAUTCA)) Q:(VEFAUTCA="")!(VEFACATY=1)  D
 .....;GET ENTRY
 .....S VEFAENTR=0
 .....S VEFAENTR=$O(^DIZ(19007,"B",VEFAUTCA,VEFAENTR))
 .....S VEFANAME=$P(^DIZ(19007,VEFAENTR,0),"^",1)
 .....I VEFADSPL[VEFANAME S VEFACATY=1
 I (VEFACATY=2)!(VEFACATY=3) S VEFACATY=0
 Q VEFACATN_" "_VEFANAME
ALERT1(X) ;D0 AS X
 N VEFACNT,VEFACAT,VEFANOTF,VEFACATY,VEFAALNT,VEFADSPL,VEFACATN,VEFAUTCA,VEFAENTR,VEFANAME
 N D0
 S D0=X
 S VEFACATN=""
 S VEFANAME=""
 S VEFACATY=0  ; NOT CATEGORY CLASS
 ;GET NOTIFICATION TYPE FOR THIS ALERT
 S VEFAALNT=$P($P($P($G(^XTV(8992.1,D0,0)),"^",1),";",1),",",3)
 ;GET DISPLAY EXT THIS TYPE OF ALERT
 S VEFADSPL=$P($G(^XTV(8992.1,D0,1)),"^",1)
 S VEFACAT=0
 F  S VEFACAT=$O(^DIZ(19008,"B",VEFACAT)) Q:(VEFACAT="")!(VEFACATY=1)  D
 .S VEFACNT=0
 .S VEFACNT=$O(^DIZ(19008,"B",VEFACAT,VEFACNT)) D
 ..;GET NOTIFICATION TYPE
 ..S VEFANOTF=$P($G(^DIZ(19008,VEFACNT,1)),"^",2)
 ..I VEFANOTF=VEFAALNT D
 ...I VEFACATY'=1 S VEFACATY=2
 ...S VEFACATN=$P($G(^DIZ(19008,VEFACNT,0)),"^",1)
 ...I VEFADSPL[VEFACATN D
 ....I VEFACATY'=1 S VEFACATY=3
 ....; LOOP THROUGH UNIQUE VEFA TRACKED CRITICAL ALERTS
 ....S VEFAUTCA=0
 ....F  S VEFAUTCA=$O(^DIZ(19007,"B",VEFAUTCA)) Q:(VEFAUTCA="")!(VEFACATY=1)  D
 .....;GET ENTRY
 .....S VEFAENTR=0
 .....S VEFAENTR=$O(^DIZ(19007,"B",VEFAUTCA,VEFAENTR))
 .....S VEFANAME=$P(^DIZ(19007,VEFAENTR,0),"^",1)
 .....I VEFADSPL[VEFANAME S VEFACATY=1
 I (VEFACATY=2)!(VEFACATY=3) S VEFACATY=0
 Q VEFANAME
FOLLOWUP(X) ;
 ;RETURN WHETHER ANY ORDER/FOLLOWUP ACTION HAS BEEN DONE. ACKNOW
 N D0,RY,VEFADFN,VEFAPRV,VEFADTIM,VEFARETN,VEFAFOLP,ZP,RY,VEFADSPL
 N VEFANAME
 N VEFADELD
 S D0=X
 S VEFADFN=$P($G(^XTV(8992.1,D0,0)),"^",4)
 S VEFADTIM=$P($P($G(^XTV(8992.1,D0,0)),"^",1),";",3)
 S VEFARETN=$$SERVIC1(X)
 S VEFANAME=$P(VEFARETN,"^",3)
 S VEFAPRV=$P(VEFARETN,"^",2)
 S VEFADSPL=$P($G(^XTV(8992.1,D0,0)),"^",1)
 ;W !,"VEFADSPL=",VEFADSPL
 ;GET ACKNOWLEDGED(DELETED) DATE (IF ANY)
 S VEFADELD=$$STATUS1(X)
 S VEFADELD=$P(VEFADELD,"^",3)
 S ZP=VEFADFN_"^"_VEFAPRV_"^"_VEFANAME_"^"_VEFADTIM_"^"_VEFADELD
 ;W !,"ZP=",ZP
 S RY=""
 D LKPORD^VEFAALR2(.RY,ZP)  ;Do a lookup for specific critical alert TYPE, and associated date/time of a real unacknowledged alert,and check whether
 ;any ORDERS by user (DUZ)have been made from list of orders in in a possible defined VEFA ALERT TRACKING entry's Reminder Dialog 
 ;(field), the dialog elements thereof containing the ORDER types (orderable iems) for such list to be compared with any actual orders 
 ;by this user (DUZ) made after the date/time of the actual critical alert. 
 ;First Verify also that type of alert passed is in VEFA ALERT TRACKING file for "followup" purposes, and has defined REMINDER DIALOG
 ; if 
 ;  ZP = DFN ^ DUZ ^ TYPE OF ALERT ^ DATE/TIME OF UNACK CRIT ALERT  ^ DELETED DATE/TIME(IF ANY)
 ;  RY= 0 (1ST PIECE=0) NO ORDERS FOUND YET
 ;  RY= 0_"^"_3  ; (1ST PIECE=0)MEANS ORDER(S) FOUND BUT NONE NOT COMPLETED OR READY FOR SIG OR NONE OF THOSE COMPLETED WITH SIG REQUIRED HAVE SIGNATURE
 ;  RY =2_"^"_1  (1ST PIECE=2) if at least one ORDER found satisfying criteria complete/signed
 ;  RY= 3_"^"_2  ;(1ST PIECE=3) MEANS NO ALERT TRACKING FILE ENTRY FOUND FOR THIS TYPE OF ALERT 
 ;  RY= 3_"^"_3  ; (1ST PIECE=3)MEANS NO REMINDER DIALOG FOUND IN ALERT TRACKINg FILE FOR THIS TYPE OF ALERT
 ;
 I RY=0 S RY="NO FAT ORDERS MADE" Q RY
 I $E(RY,1,1)=0 I $E(RY,3,3)=3 S RY="FAT ORDER(S) MADE BUT NOT COMPLETED OR SIGNED" Q RY
 I $E(RY,1,1)=2 I $E(RY,3,3)=1 S RY="ONE OR MORE FAT ORDERS/FOLLOW-UPS MADE" Q RY
 Q RY
ORDERCK1(X)  ; CONCANTENATED STRING OF ORDERS/FOLLOWUPS W/O ANY ORDERING PROVIDER ( NOT USED)
 N RY1,XX
 S XX=X
 S RY1=$$ORDERCK(XX)
 S RY1=$P(RY1,";",2,999)
 Q RY1
FOLLOWU1(X)  ; FAT  LOOK STATUS + EXTRA COLUMN FOR FAT PROVIDER ( IF FAT SATISFIED)
 N RY1,RY,XX,RY2
 S XX=X
 S RY2=""
 S RY1=$$ORDERCK(XX)
 S RY1=$P(RY1,";",1)
 I RY1'="" S RY2=$P($G(^VA(200,RY1,0)),"^",1)_" - "_RY1
 S RY=$$FOLLOWUP(XX)
 I RY="ONE OR MORE FAT ORDERS/FOLLOW-UPS MADE" S RY=RY_"^"_RY2 Q RY  ;S RY=RY_"^"_RY2 Q RY 
 S RY=RY_"^"
 Q RY
ORDERCK(X) ;
 ;RETURN LIST OF ORDER FOLLOWUP ACTION THAT HAVE BEEN DONE. FROM ACKNOWLEDGED (DELETED) ALERT DATE TIME OR CURENT TIME BACK TO DATE OF ALERT
 N D0,RY,VEFADFN,VEFAPRV,VEFADTIM,VEFARETN,VEFAFOLP,ZP,RY,VEFADSPL,VEFADELD
 N VEFANAME
 S D0=X
 S VEFADFN=$P($G(^XTV(8992.1,D0,0)),"^",4)
 S VEFADTIM=$P($P($G(^XTV(8992.1,D0,0)),"^",1),";",3)
 S VEFARETN=$$SERVIC1(X)
 S VEFANAME=$P(VEFARETN,"^",3)
 S VEFAPRV=$P(VEFARETN,"^",2)
 S VEFADSPL=$P($G(^XTV(8992.1,D0,0)),"^",1)
 ;W !,"VEFADSPL=",VEFADSPL
 ;GET ACKNOWLEDGED(DELETED) DATE (IF ANY)
 S VEFADELD=$$STATUS1(X)
 S VEFADELD=$P(VEFADELD,"^",3)
 S ZP=VEFADFN_"^"_VEFAPRV_"^"_VEFANAME_"^"_VEFADTIM_"^"_VEFADELD
 ;W !,"ZP=",ZP
 S RY=""
 D LKPORDCK^VEFAALRE(.RY,ZP)  ;Do a lookup for specific critical alert TYPE, and associated date/time of a real unacknowledged alert,and RETURN list of
 ;any ORDERS by ordering provider user (DUZ) that have been made from list of available FAT (Follow-up Alert Tracking) orders in in specifi defined VEFA ALERT TRACKING entry's Reminder Dialog 
 ; multiples(and fields)with a Reminder Dialog, the dialog elements thereof containing the ORDER types (orderable iems) for such list 
 ;to be compared with any actual orders NOT by any ordering provider user(s) (DUZ) made after the date/time of the actual critical alert UP to NOW or
 ;to date of acknowledgement(deletion) OR now time (if not passed). Do this search in reverse chronological order.
 ;First Verify also that type of alert passed is in VEFA ALERT TRACKING file for "followup" purposes, and has defined REMINDER DIALOG
 ; INPUT 
 ;  ZP = DFN ^ DUZ ^ TYPE OF ALERT ^ DATE/TIME OF UNACK CRIT ALERT ^ DATE ACKNOWLEDGED(DELETED) 
 ; RETURN
 ;  RY= ORDERING PROVIDER OFORDER/FOLLOW-UP ACTION (IF ANY)FOLLOWED BY ";" AND THEN CONCATENATED STRING OF ACTUAL ORDERS MADE EACH SEPARATED WITH ";"
 ;  
 ;
 Q RY
NONFATRC ;
 ;LOOK FROM T-180 TO T IN ALERT TRACKING FILE TO FIND NON-FAT ALERT. THE SAME FUNCTION AS VEFAALCAT(NUMBER)=0 FOR ALL NON FAT ALERTS
 ;
 N CNT,DATE,XX,DATETIME,ARRAY,NOW,ALERT,PATIENT,STATUS
 D NOW^%DTC S NOW=%
 S DATE=NOW-180-.01
 F  S DATE=$O(^XTV(8992.1,"B",DATE)) Q:(DATE>NOW)!(DATE="")  D
 .S CNT=0
 .F  S CNT=$O(^XTV(8992.1,"B",DATE,CNT)) Q:CNT=""  D
 ..S XX=$$CAT^VEFAALR1(CNT)
 ..I XX=0 D
 ...S ARRAY=$$SERVICE^VEFAALR1(CNT)
 ...S ARRAY=$P(ARRAY,"^",1,6)
 ...S PATIENT=$P(ARRAY,"^",6)
 ...;S ALERTID=$P($G(^XTV(8992.1,D0,0)),"^",1)
 ...S ALERT=$P($G(^XTV(8992.1,CNT,1)),U,1)
 ...S ALERT=$P(ALERT,": ",2)
 ...S ARRAY=ARRAY_"^"_ALERT_"^" ; FILL IN ALERT TYPE LATER
 ...S DATETIME=$P($G(^XTV(8992.1,CNT,0)),U,2)
 ...S Y=DATETIME X ^DD("DD") S DATETIME=Y
 ...S ARRAY=ARRAY_DATETIME
 ...S ARRAY=ARRAY_"^NOT TRACKED^^" ; FOR FAT ORDER DONE, FAT PROVIDER
 ...S STATUS=$$STATUS^VEFAALR1(CNT)
 ...S ARRAY=ARRAY_STATUS ; $$STATUS^VEFAALR1(CNT)
 ...S ARRAY=ARRAY_"^^" ; FOR NO LISTED FAT ORDERS/FOLLOW-UPS
 ...I (ALERT'["UNSIGNED")&(ALERT'["New consult")&(ALERT'["Order requires")&(ALERT'["New order(s)")&(ALERT'["NO-ID")&(PATIENT'="")&(ALERT'="")&(ALERT'["discontinued") W ARRAY,!
 Q
DATEFMT(X) ;
 N DATETIME
 S DATETIME=X
 S Y=DATETIME X ^DD("DD") S DATETIME=Y
 Q DATETIME
ALSP(PRPT,FILE,ARR) ; Selection of (A)LL or (S)pecific values from a given file
 ; Input: PRPT  - Piece 1: Label for the PROMPT to be asked for the 
 ;                         selection (in the plural) - e.g. "Providers"
 ;                Piece 2: Singular of piece 1 -  e.g. "Provider"
 ;                Example: "Specialties^Specialty"
 ;        FILE  - File global root (e.g., "^IBE(356.8," ) that the values
 ;                will be selected from
 ;        ARR   - Name of the array that will contain the specific values
 ;                (must be passed as a reference value ".ARR")
 ; Output: ARR  - "S" - Specific values OR "^"
 ;                The values will be returned in the array indicated in
 ;                ARR parameter 
 ;
 N DIC,PRL,SNG,X
 K ARR S PRL=$P(PRPT,"^"),SNG=$P(PRPT,"^",2) S:SNG="" SNG=PRL
 ;ALSP1 W !!,"Run report for (A)LL or (S)PECIFIC "_PRL_": A// "
 ;R X:DTIME I '$T!(X["^") S ARR="^" G QALSP
 ;S X=$S(X="":"A",1:$E(X)) I "AaSs"'[X D HALSP G ALSP1
 ;W " ",$S("Ss"[X:"SPECIFIC",1:"ALL") I "Aa"[X K ARR S ARR="A" G QALSP
 S ARR="S"
ALSP2 S DIC=FILE,DIC(0)="AEQMZ"
 S DIC("A")="   Select a"_$S($O(ARR(""))'="":"nother",1:"")_" "
 S DIC("A")=DIC("A")_SNG_": "
 D ^DIC K DIC I $D(DTOUT)!($D(DUOUT)) K ARR S ARR="^" G QALSP
 I Y'>0 G QALSP ; G ALSP1:$O(ARR(""))="" G QALSP
 I $D(ARR(+Y)) D  G ALSP2
 . W !!?3,"Already selected. Choose another "_SNG,*7,!
 S ARR(+Y)="" K DTOUT K DUOUT Q  ; ONLY ALLOW 1 PATIENT PER PATIENT PER TIME OF LAB RESULTING ALERT G ALSP2
 ;
QALSP K DTOUT K DUOUT Q
]]></Routine>
</Export>
