<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25" zv="Cache for UNIX (Red Hat Enterprise Linux 5 for x86-64) 2011.1.2 (Build 701)" ts="2014-04-25 16:36:35">
<Routine name="VEFAALR4" type="INT" languagemode="0" timestamp="63273,83469.175352"><![CDATA[
VEFAALR4 ;GOW/THC VEFA - Module for AWARE report gathering into an Alert Audit Log or Cache[ 12/01/2010 ]
 ;;1.0;VEFA;**1**;1-MAY-11;Build 17
 ;; ALSO RPC FOR RETRIEVING VEFA AWARE ALERT CACHE FORM VISTA INTO SQL SERVER TABLES
COLLECT ;
 ;;DAILY TASK WITH OPTION VEFA AWARE ALERT CACHE BUILDER
 ;;AWARE AUDIT LOG DATA AS VEFA AWARE ALERT CACHE FOR RECENT 2 WEEKS OF ACTIVITY. 
 ;;
 ;;ALSO TAKE OLDEST DAILY DATA FROM THIS CACHE AND FTP TO WINDOWS SERVER MACHINE WITH SQL SERVER
 ;;
 ;;TRUNCATE VEFA AWARE ALERT CACHE FOR DATE/TIME BEYOND TWO WEEKS+1 DAY
 ;;
 ;;UPDATE LAST STARTDATE VALUE INTO VEFA ALERT PARAMETER FILE
 ;;
 ;;DETAIL STEPS:
 ;;COLLECT alerts OVER DATE RANGE 2 WEEKS BACK ( or from last 2 weeks back date in VEFA ALERT 
 ;;PARAMETER file + 1 day) up to CURRENT TIME
 ;;check if alert belongs to CRITICAL ALERT TRACKING FILE with proper ALERT CATEGORY
 ;;         $$CAT^VEFAALR1(D0) 
 ;;Collect by service or actually by alert id, facility then service and then alert generating provider, ETC
 ;;
 ;;For each entry(D0), output an incrementally increasing comma delimited array calling these routines:
 ;;         $$SERVICE^VEFAALR1(D0)      Initial identifying fields including ALERT ID ( 5 fields)
 ;;         $$ALERT2^VEFAALR4(D0)       ALERT type and category
 ;;         $$STATUS1^VEFAALR1(D0)      RETURN A RECIPIENT'S UNACKNOWLEDGED STATUS^RENEW DATE^ACKNOWLEDGED OR DELETED DATE
 ;;         $$FOLLOWU1^VEFAALR6(D0)     Whether Followup has been done with FAT Status and Follow-up Provider if any 
 ;;         $$ORDERCK2^VEFAALR4(D0)      Follow-up provider , then List of Followup-Actions made (working backwards from current date
 ;;                                     to date of deletion/acknowledgement and made only up
 ;;                                     to any date of deletion/ack or current date from date of
 ;;                                     alert generation
 ;;Read/parse records collected and then file each record as record in the VEFA AWARE ALERT CACHE file ( daily)
 ;;
 N DATESTRT,DATEEND,D0,DATECRET,RECORD,DATETIME,ALERTID,FACNAME,SERVICE,CLINIC,PROVIDER
 N LISTVALUE,PATIENT,PATID,ALERTC,ALERTTYP,VEFASYS,VEFAPROC,VEFADELE,FATSTAT,FATPROC
 N FATPROV,FOLLUPPR,ALERTIDN,RECORD1,PATIENTID,ORIGINATOR,FULLD,MON,STATION,ALERTTY1
 N ACKGT7D,FOLLUPP1,FOLLGT7D
 N COUNT1,FILE,IENALTR,INITDATE,PRSTDATE
 N FOLLOWU
 ;;first detemine date range
 D NOW^%DTC S DATEEND=% K %
 ;S X1=%,X2=-14 D C^%DTC S DATEEND=X  TEMPORAILY OUTPUT JUST TO NOW TIME
 ;NEXT DATESTRT
 ;FIND LAST DATE START IN VEFA ALERT PARAMETERS FILE
 S DATESTRT=$P($G(^DIZ(19008.1,1,0)),"^",2)
 I DATESTRT="" D
 .;S X1=%,X2=-31 D C^%DTC S DATESTRT=X
 .S X1=2990114,X2=-15 D C^%DTC S DATESTRT=X  ;TEMPORARY FOR TESTING BUILDING ENTRIES  
 E  D
 .;S X1=DATESTRT,X2=1 D C^%DTC S DATESTRT=X   ;TEMPORARY FOR TESTING MBUILDING ENTRIES
 S $P(^DIZ(19008.1,1,0),"^",2)=DATESTRT  ;TEMPORARY FOR TESTING WITH EXTRACTION
 ;
 ;
 ;PARAMETERIZE CODE
 S WINDOW=$P($G(^DIZ(19008.1,1,0)),"^",3)
 I WINDOW="" Q
 D NOW^%DTC S PRSTDATE=% K %
 S X1=PRSTDATE,X2=-(WINDOW) D C^%DTC S DATESTRT=X
 ;
 ;
 ;FOR LOOP OVER ALERT TRACKING FILE ENTRIES BY DATE/TIME IN DATE RANGE
 ;FIND ONES THAT ARE TRACKED BY AWARE
 S DATECRET=DATESTRT
 F  S DATECRET=$O(^XTV(8992.1,"D",DATECRET)) Q:DATECRET=""  D
 .I '((DATECRET>DATESTRT)&(DATECRET<DATEEND)) Q
 .S D0=0
 .F  S D0=$O(^XTV(8992.1,"D",DATECRET,D0)) Q:D0=""  D
 ..I $$CAT^VEFAALR1(D0) D  ;AWARE TRACKED ALERT
 ...;Colect basic alert information
 ...S RECORD=$$SERVICE^VEFAALR1(D0)
 ...;Q ALERTID_"^"_FACNAME_"^"_VEFASYS_"^"_VEFAPRV1_"^"_VEFALIST_"^"_PATIENT1_"^"_$E($$ALERT(X),1,60)
 ...;Collect Tracked Alert data including type and category
 ...S RECORD=RECORD_"^"_$$ALERT2^VEFAALR4(D0)
 ...;Q VEFACATN_" "_VEFANAME
 ...;RETURN A RECIPINT'S UNACKNOWLEDGED STATUS^PROCESSES RENEW/ACK DATE^DELETED DATE
 ...;RENEW DATE MEANS NON-NULL PROCESSED DATE W/O DELETED DATE
 ...;ACKNOWLEDGED DATE MEANS NON-NULL PROCESSED DATE AND DELETE DATE
 ...;UNACKNOWLEDGED STATUS MEANS NULL PROCESSED DATE AND NULL DELETE DATE
 ...S RECORD=RECORD_"^"_$$STATUS1^VEFAALR1(D0)
 ...;Q VEFASYS_"^"_VEFAPROC_"^"_VEFADELE
 ...S RECORD=RECORD_"^"_$$FOLLOWU1^VEFAALR6(D0) ; BEFORE $$FOLLOWU1^VEFAALR1
 ...;FAT  LOOK STATUS + EXTRA COLUMN FOR FAT PROVIDER ( IF FAT SATISFIED)
 ...;NOW GET FOLLOW-UP PROVIDER AND LIST OF FOLLOW-UP ACTIONS SEPARATED WITH A ";" 
 ...S RECORD1=$$ORDERCK2^VEFAALR4(D0) ;$$ORDERCK^VEFAALR1(D0)
 ...;NEXT READ AND PARSE 
 ...S ALERTID=$P(RECORD,"^",1)
 ...S DATETIME=$P(ALERTID,";",3)  ; ALERT DATE/TIME
 ...S ORIGINATOR=$P(ALERTID,";",2)
 ...I ORIGINATOR'="" S ORIGINATOR=$P($G(^XTV(8992,ORIGINATOR,0)),"^",1)
 ...I ORIGINATOR'="" S ORIGINATOR=$P($G(^VA(200,ORIGINATOR,0)),"^",1)
 ...;S ALERTID=$P(ALERTID,";",1)
 ...S FACNAME=$P(RECORD,"^",2)
 ...S SERVICE=$P(RECORD,"^",3)
 ...S IENALTR=0  ; ALERT TRACKING IEN
 ...S CLINIC="?" ;
 ...S IENALTR=$O(^XTV(8992.1,"B",ALERTID,IENALTR))
 ...I IENALTR'="" S ORDER=$P($P($G(^XTV(8992.1,IENALTR,2)),"^",1),"@",1)
 ...I (ORDER="")!($G(^XTV(8992.1,IENALTR,2))'["@") D
 ....S CLINIC="?" ;TEMPORARILY ="" INSTEAD OF COMPUTATION , $P(RECORD,"^",5)  ; UNUSED FOR NOW OR UNDEFINED . COULD BE DETERMINED FROM 
 ...E  D
 ....S CLINIC=$P($G(^OR(100,ORDER,0)),"^",10) S CLINIC=$P(CLINIC,";",1)
 ....I CLINIC'="" D
 .....S CLINIC=$P($G(^SC(CLINIC,0)),"^",1)          ;158;SC(
 ....E  D
 .....S CLINIC="?"
 ...;PHYSICAL LOCATION IN ORIGINAL ORDER FILE ENTRY FOR ALERT ITSELF
 ...S PROVIDER=$P(RECORD,"^",4) ; WHEN DETERMINING ORDERING PROVIDER ( FROM ORDERABLE ITEM, 
 ...;LAST ORDER BEFORE PATIENT'S 
 ...;ALERT TYPE OCCURED .THERE IS ALSO GENERATED BY ( PERSON) FOR ALERT FOR PERSON GENERATING
 ...; ALERT WHEN A VALUE WAS EVALUATED AS CRITICAL , ETC. LIKE RADIOLOGIST FOR A X-RAY ORDER.
 ...S LISTVALUE=$P(RECORD,"^",5) ; ALL RECIPIENTS
 ...S PATIENTID=$P(RECORD,"^",6) ;PATIENT ID
 ...I PATIENTID'="" D
 ....S PATIENT=$P($G(^DPT(PATIENTID,0)),"^",1)
 ...E  D
 ....S PATIENT=""
 ...;S PATID=$P(RECORD,"^",9) ; FOR UNIQUE INTERNAL IDENTIFIER, BUT NOT PATIENT IDENTIFIER FOR 
 ...;LATER SQL STORAGE.
 ...S ALERTC=$P(RECORD,"^",8) ; ALERT CATEGORY
 ...S ALERTTYP=$P(RECORD,"^",9) ; ALERT TYPE
 ...S STATION=""
 ...S ALERTTY1=""
 ...S INITDATE=""
 ...I ALERTTYP'="" D
 ....S ALERTTY1=$O(^DIZ(19007,"B",ALERTTYP,0))
 ....I ALERTTY1="" Q  ;ERROR
 ....S STATION=$P($G(^DIZ(19007,ALERTTY1,3)),"^",8)
 ....S INITDATE=$P($G(^DIZ(19007,ALERTTY1,3)),"^",4) ;INPUT TRANSFORM IN PLACE FOR NOT CHANGING VALUE ONCE ENTERED
 ...I ALERTTY1="" Q
 ...I INITDATE="" Q
 ...;CHECK IF ALERTDATE > INITIATION DATE 
 ...I DATETIME<INITDATE Q
 ...S VEFASYS=$P(RECORD,"^",10)  ; UNACKNOWLEDGE STATUS
 ...S VEFAPROC=$P(RECORD,"^",11) ; RENEW/ACK PROCESS DATE TIME
 ...S MON=$E(VEFAPROC,4,7)
 ...S FULLD=$$FMTE^XLFDT(VEFAPROC,1)
 ...;;;;;;S VEFAPROC=FULLD
 ...;S MON=$E(VEFAPROC,4,7)
 ...;S FULLD=$$FMTE^XLFDT(VEFAPROC,1)
 ...;S FULLD=$P($G(FULLD),",",2)
 ...;S FULLD=$E(FULLD,2,5)
 ...;S VEFAPROC=FULLD_MON
 ...S VEFADELE=$P(RECORD,"^",12) ; DELETE DATE/TIME
 ...S MON=$E(VEFADELE,4,7)
 ...S FULLD=$$FMTE^XLFDT(VEFADELE,1)
 ...;S FULLD=$P($G(FULLD),",",2)
 ...;S FULLD=$E(FULLD,2,5)
 ...;S VEFADELE=FULLD_MON
 ...;;;;;S VEFADELE=FULLD
 ...S FATSTAT=$P(RECORD,"^",13)
 ...S FATPROC="" ; TEMPORAILY $P(RECORD,"^",16)
 ...S FATPROV=$P(RECORD,"^",14)
 ...S FOLLUPP1=$P(RECORD1,";",1) ; FOLLOW-UP PROVIDER
 ...S FOLLUPPR=$P(FOLLUPP1,"*",1)
 ...S ACKGT7D=$P(FOLLUPP1,"*",2)
 ...S FOLLGT7D=$P(FOLLUPP1,"*",3)
 ...S FOLLOWU=$P(FOLLUPP1,"*",4)
 ...I FOLLOWU'="" D
 ....S FOLLOWU=1
 ...E  D
 ....S FOLLOWU=0
 ...I FOLLUPPR'="" S FOLLUPPR=$P($G(^VA(200,FOLLUPPR,0)),"^",1)_" - "_FOLLUPPR
 ...;W !,"RECORD=",RECORD
 ...;W !,"RECORD1=",RECORD1
 ...;Q
 ...;
 ...;CHECK IF NO INITDATE ESTABLISHED YET OR REMINDER DIALOG VALUE CLEARED
 ...;W !,RECORD1
 ...I (RECORD1="3^2")!(RECORD1="3^3") W !,"ALERTID=",ALERTID Q
 ...I (FATSTAT=3)&(FATPROV=2) Q
 ...I (FATSTAT=3)&(FATPROV=3) Q
 ...;
 ...;VEFA AWARE ALERT CACHE ( 2 WEEKS OF DATA AT MOST). WILL TRUNCATE AT END AS WELL
 ...;AND WRITE WITH UPDATE ^DIE EITHER ADD NEW RECORD OR UPDATE RECORD INTO.
 ...;ADD IN FIELD NUMBER ORDER
 ...K FDA,FDAIEN,OROUT
 ...S FILE=19008.2
 ...S FDA(45,FILE,"?+1,",.01)=ALERTID   ;NAME ALERTID
 ...S FDA(45,FILE,"?+1,",1)=DATETIME  ; DATE CREATED
 ...S FDA(45,FILE,"?+1,",2)=FACNAME   ; FACILITY NAME
 ...S FDA(45,FILE,"?+1,",3)=SERVICE     ; SERVICE
 ...S FDA(45,FILE,"?+1,",4)=PROVIDER   ;ORDERING PROVIDER HOPEFULLY OR EVENTUALLY
 ...S FDA(45,FILE,"?+1,",5)=LISTVALUE         ; ALL RECIPIENTS,GENERATED WHILE QUEUED
 ...S FDA(45,FILE,"?+1,",6)=PATIENT   ; 
 ...S FDA(45,FILE,"?+1,",7)=ALERTC     ; ALERT CATEGORY
 ...S FDA(45,FILE,"?+1,",8)=ALERTTYP   ;ALERT TYPE
 ...S FDA(45,FILE,"?+1,",9)=VEFASYS   ;  
 ...S FDA(45,FILE,"?+1,",10)=VEFAPROC   ; DATE/TIME 
 ...S FDA(45,FILE,"?+1,",11)=VEFADELE     ; DATE/TIME 
 ...S FDA(45,FILE,"?+1,",12)=FATSTAT   ;FAT STATUS
 ...S FDA(45,FILE,"?+1,",13)=FATPROV   ; FAT PROVIDER
 ...S FDA(45,FILE,"?+1,",14)=FOLLUPPR   ; FOLLOWUP PROVIDER FOR ALERT
 ...S FDA(45,FILE,"?+1,",16)=CLINIC   ;  
 ...S FDA(45,FILE,"?+1,",17)=PATIENTID   ;  
 ...S FDA(45,FILE,"?+1,",18)=ORIGINATOR   ; 
 ...;S FDA(45,FILE,"?+1,",19)=GENERATED BY PERSON CL   ;
 ...S FDA(45,FILE,"?+1,",20)=STATION   ;
 ...S FDA(45,FILE,"?+1,",21)=FOLLGT7D   ;    
 ...S FDA(45,FILE,"?+1,",22)=ACKGT7D   ; 
 ...S FDA(45,FILE,"?+1,",23)=$$ALERTVAL(D0)
 ...S FDA(45,FILE,"?+1,",24)=FOLLOWU
 ...D UPDATE^DIE("","FDA(45)","FDAIEN","OROUT(45)")
 ...I $D(OROUT(45,"DIERR")) W !,"AWARE ALERT CACHE, NAME ALERTID ERROR= ",ALERTID," ",DATETIME," ",OROUT(45,"DIERR",1,"TEXT",1) Q
 ...S ALERTIDN=FDAIEN(1)
 ...K FDA(45),OROUT(45)
 ...K FDA,FDAIEN,OROUT
 ...S FILE=19008.215 ; FOLLOW UP ACTION MULTIPLE
 ...;S FDAIEN(1)=ALERTIDN
 ...S COUNT1=2
 ...F  S VALUE=$P(RECORD1,";",COUNT1) Q:(VALUE="")  D
 ....;
 ....S FDAIEN(1)=ALERTIDN
 ....;FOLLOW-UP ACTION(S)
 ....;W !,"VALUE=",VALUE
 ....S FDA(46,FILE,"?+2,"_FDAIEN(1)_",",.01)=$P(VALUE,"*",1)
 ....S FDA(46,FILE,"?+2,"_FDAIEN(1)_",",1)=$P(VALUE,"*",2) ;DATETIME  ; ALERT FIRST DISPLAYED
 ....;//S FDA(46,FILE,"?+2,"_FDAIEN(1)_",",.01)=VALUE
 ....;//S FDA(46,FILE,"?+2,"_FDAIEN(1)_",",.02)=DATETIME  ; ALERT FIRST DISPLAYED
 ....D UPDATE^DIE("","FDA(46)","FDAIEN","OROUT(46)")
 ....S COUNT1=COUNT1+1
 ....I $D(OROUT(46,"DIERR")) W !,"AWARE ALERT CACHE, FOLLOW-UP ACTION ERROR= ",VALUE," ",OROUT(46,"DIERR",1,"TEXT",1) Q
 ....;S RECIPINT=FDAIEN(2)
 ....K FDA(46),OROUT(46)
 ....K FDA,FDAIEN,OROUT
 ....;S COUNT1=COUNT1+1
 ...;
 ;UPDATE NEXT LAST START DATE
 ;ADJUST TO MAKE IT 30 DAYS BACK IF NEEDED ( IF MACHINE WAS DOWN ACROSS A DAY OR BROUGHT DOWN FOR MAINTENANCE)
 ;WELL WITH RPC INTO VISTA TO GET OLDEST DATA
 ;D NOW^%DTC S DATEEND=%
 ;;S X1=DATEEND
 ;;S X1=%,X2=1 D C^%DTC S DATESTRT=X
 ;;K X1,X2
 S $P(^DIZ(19008.1,1,0),"^",2)=PRSTDATE  ; PROCESSED DATE/TIME
 Q
EXTALERT(ORY,ZP) ; RETURN LIST OF ALERT AUDIT LOGS (CACHE) OF ALERTS TO STORE INTO SQL TABLES
 ;FOR PERIOD FROM EXTRACT STRTDATE UP TO BUT NOT INCLUDING PROCESS STRTDATE .UPON EXTRACT, THEN
 ; UPDATE EXTRACT STRT DATE IF NECESSARY UP TO PROCESS STRTDATE
 ;
 ;                 NO INPUT 
 ;                 ORY RETURN ARRAY OF LIST OF GATHERED ALERTS 
 ;NOW UPDATE TO SQL SERVER MACHINE WITH RPC TRANSFER OF CACHE DATA ( FROM NUMBER OF DAYS 
 ; IN CACHE WINDOW
 ; SUCH AS 30 DAYS AGO OR EARLIER IF MACHINE WAS DOWN)
 ;TAKE EXTRACT STRTDATE DATA UP TO AND THROUGH (TODAYS DATE). 
 ;;
 ;;
 ;;RPC AFTER TRANSFER SHOULD UPDATE EXTRACT STRTDATE= EXTRACT DATE 
 ;;RPC AFTER TRANSFER SHOULD TRUNCATE VEFA AWARE ALERT CACHE FOR DATE/TIME BEFORE EXTRACT STRTDATE 
 ;;WHICH IS UP TO CACHE WINDOW (I.E 30 DAYS)+1 DAY BACK FROM TODAY'S DATE.
 ;;
 N NAME,IEN,J,K,DATETIME,EXTSTDAT,PRSTDATE,ICOUNT,ALERTID,I,NAME,FUDATETI,ICOUNT2,FOUND,DATEEND,STATION,ALERTTYP
 N FUDATETI,STATION1,INSTITUT
 N FOLLGT7D,FOLLLT7D,ALERTID1,DATETIM1,MON,FULL,MONTH,YR,DAY,HR,MIN,SEC,DATETIM2,DATETIMH,FIRST,ALERTV,ORDERPRV
 N ORDERPID,ACKRENDT,DELETED,FOLLUPID,SECS
 K ^TMP("VEFAFOL",$J)
 K ^TMP("VEFAKB",$J)
 ;
 ;GET PROCESS START DATETIME
 S PRSTDATE=$P($G(^DIZ(19008.1,1,0)),"^",2)
 I PRSTDATE="" S ^TMP("VEFAFOL",$J)="" S ORY=$NA(^TMP("VEFAFOL",$J)) Q
 S FOUND=0
 S WINDOW=$P($G(^DIZ(19008.1,1,0)),"^",3)
 I WINDOW="" S ^TMP("VEFAFOL",$J)="" S ORY=$NA(^TMP("VEFAFOL",$J)) Q
 D NOW^%DTC S PRSTDATE=%
 S X1=PRSTDATE,X2=-(WINDOW+1) D C^%DTC S EXTSTDAT=X
 ;GET EXTRACT START DATETIME
 ;;;;;S EXTSTDAT=$P($G(^DIZ(19008.1,1,0)),"^",6)
 ;I EXTSTDAT=PRSTDATE
 ;;;;I EXTSTDAT="" D
 ;;;.S X1=PRSTDATE,X2=-31 D C^%DTC S EXTSTDAT=X
 ;;;.S $P(^DIZ(19008.1,1,0),"^",6)=EXTSTDAT
 ;S K=0
 S STATION=""
 S INSTITUT=$P($G(^XTV(8989.3,1,"XUS")),"^",17) ;DEFAULT INSTITUTION
 I INSTITUT'="" S STATION=$P($G(^DIC(4,INSTITUT,99)),"^",1)
 S DATETIME=EXTSTDAT
 D NOW^%DTC S DATEEND=%  ;TEMPORAILY
 ;F  S DATETIME=$O(^DIZ(19008.2,"C",DATETIME)) Q:(DATETIME>=PRSTDATE)!(DATETIME="")  D TEMPORAILY COMMENT OUT
 F  S DATETIME=$O(^DIZ(19008.2,"C",DATETIME)) Q:(DATETIME>=DATEEND)!(DATETIME="")  D   ;TEMPORAILY
 .S ICOUNT=0
 .F  S ICOUNT=$O(^DIZ(19008.2,"C",DATETIME,ICOUNT)) Q:ICOUNT=""  D
 ..S J=-1
 ..S FOUND=1
 ..S ALERTID=$P($G(^DIZ(19008.2,ICOUNT,0)),"^",1)
 ..S ALERTID1=$P($G(ALERTID),";",1)
 ..;GET ALERT TYPE
 ..S ALERTTYP=$P($G(^DIZ(19008.2,ICOUNT,1)),"^",4)
 ..;ALERT TYPE ORIGINATING STATION
 ..S STATION1=""
 ..I ALERTTYP'="" D
 ...S ALERTTYP=$O(^DIZ(19007,"B",ALERTTYP,0))
 ...I ALERTTYP="" Q  ;ERROR
 ...S STATION1=$P($G(^DIZ(19007,ALERTTYP,3)),"^",8)
 ..I (ALERTTYP="")!(ALERTTYP>4) Q
 ..;HEADER LINE
 ..S ^TMP("VEFAFOL",$J,0)="STATION_DATETIME_ALERTID"_"^"_"ALERTID"_"^"_"DATETIME1"_"^"_"FACILITY NAME"_"^"_"SERVICE1"_"^"_"ORDERING PROVIDER"_"^"
 ..S ^TMP("VEFAFOL",$J,0)=^TMP("VEFAFOL",$J,0)_"ALERT RECIPIENTS"_"^"_"SPARE"_"^"_"ALERT CATEGORY"_"^"_"ALERT TYPE"_"^"_"VALUE1"_"^"_"UNACKSTATUS"_"^"_"ACKRENEWDATE"_"^"
 ..S ^TMP("VEFAFOL",$J,0)=^TMP("VEFAFOL",$J,0)_"DELETEDATE"_"^"_"FAT STATUS"_"^"_"FAT PROVIDER"_"^"_"FOLLOW_UPPROVIDERID"_"^"_"CLINIC"_"^"_"PATIENTID"_"^"
 ..S ^TMP("VEFAFOL",$J,0)=^TMP("VEFAFOL",$J,0)_"ALERT RESULTOR"_"^"_"RESULTOR PERSON CLASS"_"^"_"ALERT TYPE ORIG STATION"_"^"_"FOLLOWUPGT7D"_"^"_"ACKGT7D"_"^"_"FOLLOWUPLT7D"_"^"
 ..F  S J=J+1 Q:J>5  D
 ...I (J'=4) D
 ....I '$G(^TMP("VEFAFOL",$J,STATION_"-"_DATETIME_"-"_ALERTID1)) D
 .....;J=0
 .....;FORMAT DATETIME
 .....S DATETIM1=$P($G(^DIZ(19008.2,ICOUNT,J)),"^",2)
 .....S MON=$E(DATETIM1,4,7)
 .....S FULLD=$$FMTE^XLFDT(DATETIM1,1)
 .....;S DATETIM1=FULLD
 .....;CONVERT TO HL7 DATE/TIME. CLOSE TO SQL DATE/TIME
 .....S DATETIM2=$$FMTHL7^XLFDT(DATETIM1)
 .....S DATETIMH=$E(DATETIM2,1,4)_"-"_$E(DATETIM2,5,6)_"-"_$E(DATETIM2,7,8)_" "_$E(DATETIM2,9,10)_":"_$E(DATETIM2,11,12)_":"
 .....S SECS=$E(DATETIM2,13,14)_".000" I $E(SECS,1,1)="-" S $E(SECS,1,1)="0" ; HANDLE "-O" SECS HL7 CONVERSION ERROR FOR 0 SECONDS
 .....S DATETIMH=DATETIMH_SECS
 .....;FORMATTING FOR ORDERING PROVIDER. TAKE OUT ID AS NEEDED W/O FOR USE IN DYNAMIC LOOKUP TABLE
 .....S ORDERPRV=$P($P($G(^DIZ(19008.2,ICOUNT,J)),"^",5)," - ",1)
 .....S ^TMP("VEFAFOL",$J,STATION_"-"_DATETIME_"-"_ALERTID1)=STATION_"-"_DATETIME_"-"_ALERTID1_"^"_ALERTID_"^"_DATETIMH_"^"_$P($G(^DIZ(19008.2,ICOUNT,J)),"^",3,4)_"^"_ORDERPRV_"^"
 ....E  D
 .....I J=1 S ALERTV=$P($G(^DIZ(19008.2,ICOUNT,6)),"^",1)
 .....I J=1 S ^TMP("VEFAFOL",$J,STATION_"-"_DATETIME_"-"_ALERTID1)=^TMP("VEFAFOL",$J,STATION_"-"_DATETIME_"-"_ALERTID1)_$P($G(^DIZ(19008.2,ICOUNT,J)),"^",1,1)_"^"_""_"^"_$P($G(^DIZ(19008.2,ICOUNT,J)),"^",3,4)_"^"_ALERTV_"^"
 .....I J=2 D
 ......;CONVERT TO HL7 DATE/TIME. CLOSE TO SQL DATE/TIME
 ......S DATETIM1=$P($G(^DIZ(19008.2,ICOUNT,J)),"^",2)
 ......S ACKRENDT=""
 ......I DATETIM1'="" D
 .......S DATETIM2=$$FMTHL7^XLFDT(DATETIM1)
 .......S ACKRENDT=$E(DATETIM2,1,4)_"-"_$E(DATETIM2,5,6)_"-"_$E(DATETIM2,7,8)_" "_$E(DATETIM2,9,10)_":"_$E(DATETIM2,11,12)_":"
 .......S SECS=$E(DATETIM2,13,14)_".000" I $E(SECS,1,1)="-" S $E(SECS,1,1)="0" ; HANDLE "-O" SECS HL7 CONVERSION ERROR FOR 0 SECONDS
 .......S ACKRENDT=ACKRENDT_SECS
 ......;CONVERT TO HL7 DATE/TIME. CLOSE TO SQL DATE/TIME
 ......S DATETIM1=$P($G(^DIZ(19008.2,ICOUNT,J)),"^",3)
 ......S DELETED=""
 ......I DATETIM1'="" D
 .......S DATETIM2=$$FMTHL7^XLFDT(DATETIM1)
 .......S DELETED=$E(DATETIM2,1,4)_"-"_$E(DATETIM2,5,6)_"-"_$E(DATETIM2,7,8)_" "_$E(DATETIM2,9,10)_":"_$E(DATETIM2,11,12)_":"
 .......S SECS=$E(DATETIM2,13,14)_".000" I $E(SECS,1,1)="-" S $E(SECS,1,1)="0" ; HANDLE "-O" SECS HL7 CONVERSION ERROR FOR 0 SECONDS
 .......S DELETED=DELETED_SECS
 .....I J=2 S ^TMP("VEFAFOL",$J,STATION_"-"_DATETIME_"-"_ALERTID1)=^TMP("VEFAFOL",$J,STATION_"-"_DATETIME_"-"_ALERTID1)_$P($G(^DIZ(19008.2,ICOUNT,J)),"^",1)_"^"_ACKRENDT_"^"_DELETED_"^"_$P($G(^DIZ(19008.2,ICOUNT,J)),"^",4)_"^"
 .....I J=3 S FOLLUPID=$P($P($G(^DIZ(19008.2,ICOUNT,3)),"^",2)," - ",2) I FOLLUPID="" S FOLLUPID=0
 .....I J=3 S ^TMP("VEFAFOL",$J,STATION_"-"_DATETIME_"-"_ALERTID1)=^TMP("VEFAFOL",$J,STATION_"-"_DATETIME_"-"_ALERTID1)_$P($G(^DIZ(19008.2,ICOUNT,J)),"^",1,1)_"^"_FOLLUPID_"^"
 .....I J=5 D
 ......;TOGGLE FOLLOWUPGT7D INTO FOLLOWUPLT7D FOR REPORTS
 ......S FOLLGT7D=$P($G(^DIZ(19008.2,ICOUNT,J)),"^",6)
 ......I FOLLGT7D=1 D
 .......S FOLLLT7D=0
 ......E  D
 .......S FOLLLT7D=1
 .....I J=5 S ^TMP("VEFAFOL",$J,STATION_"-"_DATETIME_"-"_ALERTID1)=^TMP("VEFAFOL",$J,STATION_"-"_DATETIME_"-"_ALERTID1)_$P($G(^DIZ(19008.2,ICOUNT,J)),"^",1,7)_"^"_FOLLLT7D_"^"
 ....;I $G(^DIZ(19008.2,ICOUNT,J)) S ^TMP("VEFAFOL",$J,ALERTID,J)=$G(^DIZ(19008.2,ICOUNT,J))
 ..S NAME=0
 ..S K=0
 ..;FOLLOW-UP ACTIONS NEXT
 ..;HEADER FIRST 
 ..S FIRST=0
 ..;S ^TMP("VEFAFOL",$J,STATION_"-"_DATETIME_"-"_ALERTID1,"FOLLOWUP",0)="STATION-DATETIME-ALERTID1"_"^"_"FOLLOWUP"_"^"_"FOLLOWUPDATETIME"
 ..F  S NAME=$O(^DIZ(19008.2,ICOUNT,4,"B",NAME)) Q:NAME=""  D
 ...S FIRST=1
 ...S ICOUNT2=0
 ...S ICOUNT2=$O(^DIZ(19008.2,ICOUNT,4,"B",NAME,ICOUNT2))
 ...I ICOUNT2'="" S FUDATETI=$P($G(^DIZ(19008.2,ICOUNT,4,ICOUNT2,0)),"^",2)
 ...;FORMAT DATETIME
 ...S DATETIM1=$P($G(^DIZ(19008.2,ICOUNT,4,ICOUNT2,0)),"^",2)
 ...S MON=$E(DATETIM1,4,7)
 ...S FULLD=$$FMTE^XLFDT(DATETIM1,1)
 ...;S DATETIM1=FULLD
 ...;CONVERT TO HL7 DATE/TIME. CLOSE TO SQL DATE/TIME
 ...S DATETIM2=$$FMTHL7^XLFDT(DATETIM1)
 ...S DATETIMH=$E(DATETIM2,1,4)_"-"_$E(DATETIM2,5,6)_"-"_$E(DATETIM2,7,8)_" "_$E(DATETIM2,9,10)_":"_$E(DATETIM2,11,12)_":"_"00"_".000"
 ...S ^TMP("VEFAFOL",$J,STATION_"-"_DATETIME_"-"_ALERTID1,"FOLLOWUP",ICOUNT2)=STATION_"-"_DATETIME_"-"_ALERTID1_"^"_"FOLLOWUP"_"^"_$P($G(^DIZ(19008.2,ICOUNT,4,ICOUNT2,0)),"^",1)_"^"_DATETIMH_"^"
 ..I FIRST=0 D
 ...; SEND FAKE FOLLOWUP TO ALLOW INNER JOINS TO ALWAYS BE FOUND IN MS SQL REPORTING SERVICE. LATER MAKE INVISIBLE
 ...S DATETIM2=$$FMTHL7^XLFDT(DATETIME)
 ...S DATETIMH=$E(DATETIM2,1,4)_"-"_$E(DATETIM2,5,6)_"-"_$E(DATETIM2,7,8)_" "_$E(DATETIM2,9,10)_":"_$E(DATETIM2,11,12)_":"_$E(DATETIM2,13,14)_".000"
 ...S ^TMP("VEFAFOL",$J,STATION_"-"_DATETIME_"-"_ALERTID1,"FOLLOWUP",1)=STATION_"-"_DATETIME_"-"_ALERTID1_"^"_"FOLLOWUP"_"^"_"DUMMY FOLLOWUP"_"^"_DATETIMH_"^"
 S ^TMP("VEFAFOL",$J)=""
 S ORY=$NA(^TMP("VEFAFOL",$J))
 ;ADD KB EXTRACT HERE FOR ALERT CATEGORY AND ALERT FOLLOWUP PER FACILITY
 ;
 ;SAVE LAST EXTRACT STRTDATE AS PROCESS DATETIME-(CACHE WINDOW+1) 
 I FOUND D
 .;S X1=PRSTDATE,X2=-31 D C^%DTC S EXTSTDAT=X
 .S $P(^DIZ(19008.1,1,0),"^",6)=EXTSTDAT
 ;
 ;TRUNCATE VEFA AWARE CACHE
 D DELCACHE
 Q
 ;
BASICCHK(RY,ZP) ;
 ;TAKE  INPUT IN ZP( ALERT TYPE ) IN FILE 19007. 
 ;BASIC CHECKS
 ;
 ;WHEN REMINDER DIALOG VALUE ENTERED IN FILE 19007 
 ;
 ;DO LOOKUP for all ORDER DIALOG AND FOLLOW-UP ITEMS INCLUDED IN DIALOG AND FOLLOWUP GROUP(S) RESPECTIVELY
 ;Also look FOR REMINDER DIALOG NAMES TO CONFORM TO NOTATION "AW"_STATION+UNIQUE CODE OF ALERT TYPE+DESCCRIPTION
 ; , I.E. AS "AW500 PSA PAT OPTED NO TREAT" FOR AWARE from station 500 and description following.
 ;
 ; CHECK UNIQUENESS AMONG associated REMINDER DIALOGs with "Order Dialog Text" and 
 ; "Followup Dialog Box Text" values: 
 ;DO LOOKUP of Dialog/Progress Note text to check for matching entries needed with 
 ;Orders Dialog Box Text or Followup Dialog Box Text included in this WP field included 
 ;in at least one line of text.
 ;
 ;Build array of Alert Order Dialog and Followup Item Texts with matching REMINDER DIALOG 
 ;and INTERNAL ENTRY number of Reminder Order Dialog or Follow-up text foind from trace
 ;through Reminder Dialog type Reminder dialog to all its groups and elements correlated to
 ;element box text(s) in the VEFA Tracked Critical Alert(the ALERT TYPE)file (19007).
 ;
 ; 
 ;Check for duplicates or missing entries and report back as error
 ;
 ;Check if any 3rd group as single item for Followup Comments in WP text on Reminder dialog as 
 ; as TYPE "prompt".
 ;
 ;Also check for proper same NOTATION for the REMINDER DIALOG group type reminde dialogs with 
 ;notation as described above, as well as main REMINDER DIALOG type reminder dialog name itself 
 ;as in example "AW500 PSA" ONLY w/o any further description.
 ;
 ;S RY ="OK" or "ERR=error comment...." sufficient for a CAC to fix error.
 ;    
 N REMINDER,NAME,IEN
 N VEFADFN,VEFADUZ,VEFAALRT,VEFAADTT,VEFARMDL
 N VEFACNT,VEFACNT1,VEFACNT2
 N DISABLE,REMDIALG,DIALOGTY,DIALOGEL,RESOLTYP,ORDRITM,COUNTER,CNTORD,CNT1,ORDER,CNTTIMO,CNTTIMA
 N REVERST,CNTPAT,ORDERCK
 N RYY,ACTION,ACTIONK,SIGSTAT
 N FOLLUPCT,FOLLOWAC
 N VHEALTH,OVERFLAG,VHEALF,FOLLOWUP,VISITPTR,ACTIVE,COUNTER1,COUNTER2,PTR,REMELEM,BOXTEXT,IENS,DR
 N DIALOGN,VALUE,ORDERITEM,FINDING,ALERTGEN,ORDITEMN,ORDITEMD,ORDERDLG,ORDERDLR,ORDRDIGR,ORDRPKG
 N ORDRDPKG,ORDRFOLU,ORDERDLN,AWSITE,ORDITEMR,ORDRDPK1,ORDRPK1
 N FOLLHEAL,OVER,REMTYPE
 S RY=""
 I $G(ZP)="" S RY="Invalid Alert Type Name" QUIT
 ;
 S REMINDER=""
 S NAME=ZP
 S IEN=$O(^DIZ(19007,"B",NAME,0))
 I IEN="" S RY="Alert Type Not Found" QUIT
 S REMINDER=$P($G(^DIZ(19007,IEN,3)),"^",1)
 I REMINDER="" S RY="Reminder Dialog Not Found" QUIT
 ;
 ;.S ACTIVE=$P($G(^DIZ(19007,IEN,3)),"^",5)
 ;.I ACTIVE="" S ACTIVE=0
 ;I REMINDER'="" S REMINDER=$P($G(^PXRMD(801.41,REMINDER,0)),"^",1)  ; TYPE = REMINDER DIALOG
 ;I (REMINDER'="")&(TIUTEMPL'="") S RY=IEN_"^"_REMINDER_"^"_TIUTEMPL_"^"
 ;
 ;REMINDER DIALOG DEFINED. NOW DO BASIC CHECKS
 ;FOLLOW PATH FIRST WITH Reminder Dialog groups (1ST GROUP IS FOR ORDERS) AND 2ND FOR (FOLLOW-UP COMMENTS),
 ;3RD FOR FOLLOWUP COMMENTS WP field.
 ;K RY
 S RY=0
 S COUNTER=0 ; FOR ORDERS
 S COUNTER1=0  ; FOR FOLLOWUP ACTIONS
 S COUNTER2=0 ; FOR UNIQUE DESIRED REMINDER DIALOG ELEMENT NAMES
 K ^TMP($J,"ORDERITEM")
 K ^TMP($J,"FOLLOWUPITEM")
 ;determine AWSITE = "AW"_SITE ( i.e. AW500 )
 S AWSITE="AW"_$P($G(^DIZ(19007,IEN,3)),"^",8)
 K ^TMP($J,"REMINDER ELEMENTS")
 ;PREPARE LST OF DESIRED REMINDER DIALOG ELEMENT NAMES
 ;GO THRU LIST OF TEXT BOX DATA IN ALERT TYPE RECORD
 ;FIRST IN DESIRED ORDER GROUP
 S BOXTEXT=0
 F  S BOXTEXT=$O(^DIZ(19007,IEN,1,"B",BOXTEXT)) Q:BOXTEXT=""  D
 .S PTR=0
 .S PTR=$O(^DIZ(19007,IEN,1,"B",BOXTEXT,PTR))
 .S IENS=PTR_","_IEN
 .S DR=.3 ;DESIRED ELEMENT NAME
 .S REMELEM=$$GET1^DIQ(19007.01,IENS,DR,"I") ;W !,REMELEM ;
 .S DR=.7 ;ORDERABLE ITEM NAME REQUIRED (NO/YES)
 .S ORDITEMR=$$GET1^DIQ(19007.01,IENS,DR,"I") ;W !,REMELEM 
 .S DR=3.5
 .S ORDRDPKG=$$GET1^DIQ(19007.01,IENS,DR,"I") ;W !,ORDRDPKG ; 
 .S COUNTER2=COUNTER2+1
 .S ^TMP($J,"REMINDER DIALOG",COUNTER2)=REMELEM_U_PTR_U_ORDRDPKG_U_"19007.01"_U_BOXTEXT_U_ORDITEMR
 ;
 ;SECOND IN DESIRED FOLLOWUP ACTION GROUP
 S BOXTEXT=0
 F  S BOXTEXT=$O(^DIZ(19007,IEN,2,"B",BOXTEXT)) Q:BOXTEXT=""  D
 .S PTR=0
 .S PTR=$O(^DIZ(19007,IEN,2,"B",BOXTEXT,PTR))
 .S IENS=PTR_","_IEN
 .S DR=.3 ;DESIRED ELEMENT NAME
 .S REMELEM=$$GET1^DIQ(19007.02,IENS,DR,"I") ;W !,REMELEM ;
 .S DR=.7 ;ORDERABLE ITEM NAME REQUIRED (NO/YES)
 .S ORDITEMR=$$GET1^DIQ(19007.02,IENS,DR,"I") ;W !,REMELEM 
 .S DR=3.5
 .S ORDRDPKG=$$GET1^DIQ(19007.02,IENS,DR,"I") ;W !,ORDRDPKG ; 
 .S COUNTER2=COUNTER2+1
 .S ^TMP($J,"REMINDER DIALOG",COUNTER2)=REMELEM_U_PTR_U_ORDRDPKG_U_"19007.02"_U_BOXTEXT_U_ORDITEMR
 ;
 ;
 ;THIRD IN DESIRED COMMENTS GROUP
 S BOXTEXT=0
 F  S BOXTEXT=$O(^DIZ(19007,IEN,4,"B",BOXTEXT)) Q:BOXTEXT=""  D
 .S PTR=0
 .S PTR=$O(^DIZ(19007,IEN,4,"B",BOXTEXT,PTR))
 .S IENS=PTR_","_IEN
 .S DR=.3 ;DESIRED ELEMENT NAME
 .S REMELEM=$$GET1^DIQ(19007.03,IENS,DR,"I") ;W !,REMELEM ;
 .S DR=.7 ;ORDERABLE ITEM NAME REQUIRED (NO/YES)
 .S ORDITEMR=$$GET1^DIQ(19007.03,IENS,DR,"I") ;W !,REMELEM 
 .S DR=3.5
 .S ORDRDPKG=$$GET1^DIQ(19007.03,IENS,DR,"I") ;W !,ORDRDPKG ; 
 .S COUNTER2=COUNTER2+1
 .S ^TMP($J,"REMINDER DIALOG",COUNTER2)=REMELEM_U_PTR_U_ORDRDPKG_U_"19007.03"_U_BOXTEXT_U_ORDITEMR
 ;
 ;S VEFADFN=$P(ZP,U,1) S VEFADUZ=$P(ZP,U,2) S VEFAALRT=$P(ZP,U,3) S VEFAADTT=$P(ZP,U,4)
 ;
 ;first CHECK if type of alert if in VEFA ALERT TRACKING file
 S VEFACNT=IEN
 D
 .;
 .; RECORD # in VEFA TRACKED ALERTS file
 .; get reminder dialog 
 .S VEFARMDL=REMINDER ;
 .I VEFARMDL'="" D
 ..;
 ..;GO TO FILE 801.41
 ..;CHECK IF DISABLED
 ..S DISABLE=$P($G(^PXRMD(801.41,VEFARMDL,0)),U,3)
 ..I (DISABLE=0)!(DISABLE="") D
 ...;
 ...;CHECK REMINDER TYPE AS "REMINDER DIALOG"
 ...S REMTYPE=$P($G(^PXRMD(801.41,VEFARMDL,0)),U,4)
 ...I REMTYPE="R" D
 ....;
 ....; LOOK THROUGH DIALOG GROUPS AND THEIR ELEMENTS TO FIND ORDERABLE ANY ORDER ITEMS.
 ....S VEFACNT=0
 ....F  S VEFACNT=$O(^PXRMD(801.41,VEFARMDL,10,"B",VEFACNT)) Q:(VEFACNT="")!(RY'=0)  D
 .....;GET INTERNAL ENTRY #
 .....S VEFACNT1=0
 .....S VEFACNT1=$O(^PXRMD(801.41,VEFARMDL,10,"B",VEFACNT,VEFACNT1))
 .....;
 .....I VEFACNT1'="" D
 ......; GET DIALOG GROUP OR DIRECT DIALOG ELEMENT (ASSUME FOR NOW ONLY DIALOG GROUP WITH ORDERS)
 ......S REMDIALG=$P($G(^PXRMD(801.41,VEFARMDL,10,VEFACNT1,0)),U,2)
 ......;
 ......I REMDIALG'="" D
 .......; CHECK IF DIALOG GROUP
 .......S DIALOGTY=$P($G(^PXRMD(801.41,REMDIALG,0)),U,4)
 .......I DIALOGTY="G" D   ; DIALOG GROUP
 ........;
 ........S VEFACNT2=0 ; GET DIALOG ELEMENTS INSIDE THIS DIALOG GROUP
 ........F  S VEFACNT2=$O(^PXRMD(801.41,REMDIALG,10,"B",VEFACNT2)) Q:(VEFACNT2="")!(RY'=0)  D
 .........;GET INTERNAL ENTRY #
 .........S DIALOGEL=0
 .........S DIALOGEL=$O(^PXRMD(801.41,REMDIALG,10,"B",VEFACNT2,DIALOGEL))
 .........; DIALOG ELEMENT
 .........;
 .........S DIALOGEL=$P($G(^PXRMD(801.41,REMDIALG,10,DIALOGEL,0)),U,2)
 .........;
 .........;GET NAME OF DIALOG ELEMENT
 .........S DIALOGN=$P($G(^PXRMD(801.41,DIALOGEL,0)),U,1)
 .........;COMPARE TO SEE IF FOUND MATCH AND NOT DUPLICATE MATCH
 .........S COUNTER2=0
 .........S OVER=0
 .........F  S COUNTER2=$O(^TMP($J,"REMINDER DIALOG",COUNTER2)) Q:(OVER'=0)!(COUNTER2="")  D
 ..........S VALUE=$P($G(^TMP($J,"REMINDER DIALOG",COUNTER2)),"^",1)
 ..........I VALUE=DIALOGN D
 ...........I $P($G(^TMP($J,"REMINDER DIALOG",COUNTER2)),"^",7)'=1 D
 ............S $P(^TMP($J,"REMINDER DIALOG",COUNTER2),"^",7)=1
 ............S ORDRDPKG=$P($G(^TMP($J,"REMINDER DIALOG",COUNTER2)),"^",3) ; DESIRED PKG IN ASSOCIATED ORDER DIALOG 
 ............S ORDRFOLU=$P($G(^TMP($J,"REMINDER DIALOG",COUNTER2)),"^",4) ; ORDER OR FOLLOWUP GROUP SUB FILE #
 ............S BOXTEXT=$P($G(^TMP($J,"REMINDER DIALOG",COUNTER2)),"^",5) ; BOX TEST IN ORDER OR FOLLOWUP GROUP SUB FILE #
 ............S ORDITEMR=$P($G(^TMP($J,"REMINDER DIALOG",COUNTER2)),"^",6) ;ORDERABLE ITEM REQUIRED 
 ............S OVER=$P($G(^TMP($J,"REMINDER DIALOG",COUNTER2)),"^",2) ;INTERNAL ENTRY IN ALERT TYPE GROUP FILE
 ...........E  D
 ............S OVER=-1
 ............I RY=0 S RY="ERR="_"Duplicate dialog element name = "_DIALOGN
 .........I OVER=0 S OVER=-1 I RY=0 D
 ..........S RY="Continue "_"by entering the reminder dialog element "_DIALOGN_" into the Desired Element Name field of the associated(next)KB Element."
 ..........;S RY="ERR="_"Missing or Misnamed dialog element name "_DIALOGN_" without leading AW_Site"_" Alert Type Mneumonic (i.e. AW500 XXX). Desired Element Name value should also be filled"
 .........I OVER=-1 Q
 .........S ALERTGEN=OVER ;ALERT TYPE GROUP INTERNAL ENTRY NUMBER FOR WRITE/UPDATING
 .........;
 .........;READ FROM REMINDER ELEMENT AND WRITE ANY DIALOG/PROGRESS NOTE TEXT HERE BACK INTO ALERT TYPE FILE
 .........;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
 .........;
 .........D GETPROG(DIALOGEL)  ; GET PROGRESS NOTE TEXT FORM REMINDER DIALOG ELEMENT
 .........D WRITPROG(IEN,ORDRFOLU,ALERTGEN)
 .........;CHECK "ORDER" RESOLUTION TYPE FIRST
 .........S RESOLTYP=$P($G(^PXRMD(801.41,DIALOGEL,1)),U,3)
 .........I RESOLTYP=3 D
 ..........;GET ORDERABLE ITEMS FILE ENTRY AS POSSIBLE FOLLOW-UP ACTION CHOICE. STORE INTO ^TMP($J,"ORDERITEM,COUNTER) ARRAY
 ..........S ORDERITEM=$P($G(^PXRMD(801.41,DIALOGEL,1)),U,7)
 ..........;CHECK ORDERABLE ITEM REQUIRED
 ..........S OVER=0
 ..........I (ORDITEMR=1) D
 ...........I ORDERITEM="" S OVER=1 I RY=0 S RY="ERR="_"NO ORDERABLE ITEM FOUND IN ORDER DIALOG "_DIALOGN_" WHEN ONE IS REQUIRED"
 ..........; NOW LOOK AT ORDERS IF ANY AND CHECK DATE/TIME > DATE/TIME OF PASSED CRIT ALERT
 ..........I OVER=1 Q
 ..........S COUNTER=COUNTER+1
 ..........;
 ..........S ^TMP($J,"ORDERITEM",COUNTER)=ORDERITEM
 ..........;GET ORDERABLE ITEM NAME
 ..........I ORDERITEM'="" D
 ...........S ORDITEMN=$P($G(^ORD(101.43,ORDERITEM,0)),"^",1)  ; CHECK ^GLOBAL FOR ORDERABLE ITEM
 ...........;GET DISPLAY GROUP 
 ..........E  D
 ...........S ORDITEMN=""
 ..........;GET ORDERABLE ITEM DISPLAY GROUP
 ..........IF ORDERITEM'="" D
 ...........S ORDITEMD=$P($G(^ORD(101.43,ORDERITEM,0)),"^",5)  ; CHECK ^GLOBAL AND PIECE FOR ORDERABLE ITEM DISPLAY GROUP
 ...........;I ORDITEMD'="" S ORDRITEMD=$P($G(^ORDGRP(ORDITEMD,0)),"^",1)  ; CHECK ^GLOBAL AND PIECE FOR DISPLAY GROUP
 ..........E  D
 ...........S ORDITEMD=""
 ..........;ORDER DIALOG TYPE FINDING HERE. FINDING MUST EXIST. HAS TO BE ORDER DIALOG TYPE. FIND DISPLAY GROUP
 ..........;AND ORDER DIALOG PACKAGE HAS TO MATCH DESIRED PACKAGE ENTRY.
 ..........;
 ..........S ORDERDLG=$P($G(^PXRMD(801.41,DIALOGEL,1)),U,5)  ;CHECK PIECE, NODE ETC
 ..........;CHECK IF ORDER DIALOG (QUICK ORDER) ONLY
 ..........;GET ORGER DIALOG VALUE AS FINDING TYPE IN FORM "500156;ORD(101.41," WHERE NUMERIC LIKE xxxxxxx check global
 ..........;500156 IS INTERNAL # FOR ORDER DIALOG RECORD NUMBER
 ..........S ORDERDLR="" ; ORDER DIALOG RECORD NUMBER
 ..........I ORDERDLG["ORD(101.41," D
 ...........S ORDERDLR=$P(ORDERDLG,";",1)
 ..........S ORDRDIGR="" S ORDRPKG=""
 ..........S OVER=0
 ..........S ORDERDLN="" ; ORDER DIALOG NAME
 ..........I (ORDERDLR'="") D
 ...........S ORDERDLN=$P($G(^ORD(101.41,ORDERDLR,0)),"^",1) ; ORDER DIALOG NAME ,FIND CORRECT ORDER DIALOG PIECE, NODE 
 ...........S ORDRDIGR=$P($G(^ORD(101.41,ORDERDLR,0)),"^",5) ; DISPLAY GROUP ,FIND CORRECT ORDER DIALOG PIECE, NODE 
 ...........S ORDRPKG=$P($G(^ORD(101.41,ORDERDLR,0)),"^",7)  ; PACKAGE ,FIND CORRECT ORDER DIALOG PIECE, NODE 
 ..........;I (ORDERDLG'="")&(ORDERDLN["AWSITE" D
 ..........I (ORDERDLG'="") D
 ...........;
 ..........E  D
 ...........;UPDATE ALERT TYPE FILE TO POINT OF ERROR, THEN QUIT WITH RETURN RY
 ...........K FDA,FDAIEN,OROUT
 ...........S FILE=ORDRFOLU ; ORDER OR FOLLOW UP ACTION MULTIPLE
 ...........S IENS=ALERTGEN_","_IEN_","
 ...........S FDA(46,FILE,IENS,.01)=BOXTEXT
 ...........S FDA(46,FILE,IENS,.5)=ORDITEMN  ;  
 ...........S FDA(46,FILE,IENS,1)=ORDITEMD  ;
 ...........D FILE^DIE("","FDA(46)","OROUT(46)")
 ...........I $D(OROUT(46,"DIERR")) I RY=0 S RY="ORDER/FOLLOW-UP/COMMENTS GROUP ENTRY ERROR= "_BOXTEXT_" "_OROUT(46,"DIERR",1,"TEXT",1) S OVER=1 K FDA(46),OROUT(46) Q
 ...........K FDA(46),OROUT(46)
 ...........I ORDERDLG="" I RY=0 S RY="ERR="_"NO FINDING ORDER DIALOG FOUND FOR DIALOG ELEMENT "_DIALOGN
 ...........;I ORDERDLG'="" I RY=0 S RY="ERR="_"ORDER DIALOG NAME FOR DIALOG ELEMENT "_DIALOGN_ "NOT INCLUDING "AW"_SITE
 ...........S OVER=1
 ..........I OVER=1 Q
 ..........;CHECK IF THERE IS DESIRED PACKAGE WITH AN ORDER DIALOG 
 ..........I ORDRDPKG="" D
 ...........S OVER=1 I RY=0 S RY="ERR="_"FOR DEFINED ORDER DIALOG "_ORDERDLN_" IN DIALOG ELEMENT "_DIALOGN_" DOES NOT HAVE DESIRED PACKAGE"
 ..........I OVER=1 Q
 ..........;CHECK INTERNAL ORDRPKG AGAINST INTERNAL DESIRED PACKAGE IF ORDRPKG IS DEFINED
 ..........S OVER=0
 ..........I ORDRDPKG'="" D
 ...........I ORDRDPKG'=ORDRPKG S OVER=1
 ..........I OVER=1 D  Q
 ...........;UPDATE ALERT TYPE FILE TO POINT OF ERROR, THEN QUIT WITH RETURN RY
 ...........K FDA,FDAIEN,OROUT
 ...........S FILE=ORDRFOLU ; ORDER OR FOLLOW UP ACTION 0R COMMENTS MULTIPLE
 ...........S IENS=ALERTGEN_","_IEN_","
 ...........S FDA(46,FILE,IENS,.01)=BOXTEXT
 ...........S FDA(46,FILE,IENS,.5)=ORDITEMN  ;  
 ...........S FDA(46,FILE,IENS,1)=ORDITEMD  ;
 ...........S FDA(46,FILE,IENS,1.5)=ORDERDLN  ; 
 ...........S FDA(46,FILE,IENS,2)=ORDRDIGR  ;  
 ...........D FILE^DIE("","FDA(46)","OROUT(46)")
 ...........I $D(OROUT(46,"DIERR")) I RY=0 S RY="ORDER/FOLLOW-UP/COMMENTS GROUP ENTRY ERROR= "_BOXTEXT_" "_OROUT(46,"DIERR",1,"TEXT",1) S OVER=1 K FDA(46),OROUT(46) Q
 ...........K FDA(46),OROUT(46)
 ...........S ORDRDPK1=$P($G(^DIC(9.4,ORDRDPKG,0)),"^",1)
 ...........S ORDRPK1=$P($G(^DIC(9.4,ORDRPKG,0)),"^",1)
 ...........I RY=0 S RY="ERR="_"DESIRED PACKAGE "_ORDRDPK1_" FOR DIALOG ELEMENT "_DIALOGN_" NOT MATCHING PACKAGE "_ORDRPK1_" IN ORDER DIALOG "_ORDERDLN
 ..........;
 ..........;new section. Also allow health factor to resolve with non-specifc orderable item (like anti-biotics in general)
 ..........S FOLLUPCT=0
 ..........S OVER=1
 ..........F  S FOLLUPCT=$O(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT)) Q:(FOLLUPCT="")!(FOLLUPCT="B")  D
 ...........S FOLLOWAC=$P($G(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT,0)),"^",1)  ;DYNAMIC POINTER
 ...........;LOOK FOR V HEALTH FACTOR TYPE ONLY
 ...........;GET FOLLOUP ACTION HEALTH FACTOR AS ADDITIONAL FINDING TYPE IN FORM "500156;AUTTHF(" WHERE NUMERIC LIKE 
 ...........;500156 IS INTERNAL # FOR HEALTH FACTOR ENTRY
 ...........I FOLLOWAC["AUTTHF(" D
 ............S COUNTER1=COUNTER1+1
 ............S ^TMP($J,"FOLLOWUPITEM",COUNTER1)=FOLLOWAC
 ............I (OVER=0)!(OVER=2) D
 .............S OVER=2
 ............E  D
 .............S OVER=0
 .............S FOLLHEAL=$P(FOLLOWAC,";",1)
 .............I FOLLHEAL'="" S FOLLHEAL=$P($G(^AUTTHF(FOLLHEAL,0)),"^",1) ;;GOW ADDED 2/8/2014
 ..........I OVER=1 D
 ...........I RY=0 S RY="ERR="_"NO HEALTH FACTOR FOUND AS ADDITIONAL FINDING IN DIALOG ELEMENT "_DIALOGN
 ..........;I OVER=2 D
 ..........;.I RY=0 S RY="ERR="_"MULTIPLE HEALTH FACTORS FOUND AS ADDITIONAL FINDING IN DIALOG ELEMENT "_DIALOGN
 ..........;I (OVER=1)!(OVER=2) Q
 ..........I (OVER=1) Q
 ..........;NOW WRITE CORRECT VALUES UP TO AND INCLUDING HEALTH FACTOR FOUND AS ADDITIONAL FINDING
 ..........K FDA,FDAIEN,OROUT
 ..........S FILE=ORDRFOLU ; ORDER OR FOLLOW UP ACTION MULTIPLE
 ..........S IENS=ALERTGEN_","_IEN_","
 ..........S FDA(46,FILE,IENS,.01)=BOXTEXT
 ..........S FDA(46,FILE,IENS,.5)=ORDITEMN  ;  
 ..........S FDA(46,FILE,IENS,1)=ORDITEMD  ;
 ..........S FDA(46,FILE,IENS,1.5)=ORDERDLN  ; 
 ..........S FDA(46,FILE,IENS,2)=ORDRDIGR  ;  
 ..........S FDA(46,FILE,IENS,4)=FOLLHEAL  ;
 ..........S FDA(46,FILE,IENS,7)=ORDRPKG  ;
 ..........D FILE^DIE("","FDA(46)","OROUT(46)")
 ..........I $D(OROUT(46,"DIERR")) I RY=0 S RY="ORDER/FOLLOW-UP/COMMENTS GROUP ENTRY ERROR= "_BOXTEXT_" "_OROUT(46,"DIERR",1,"TEXT",1) S OVER=1 K FDA(46),OROUT(46) Q
 ..........K FDA(46),OROUT(46)
 ..........;end new section
 .........E  D
 ..........;IF in any group, check resolution type as not "ordered", flag as error any found orderable item or order dialog 
 ..........;or other finding type in this 2nd group. Flag as error
 ..........S ORDERITEM=$P($G(^PXRMD(801.41,DIALOGEL,1)),U,7) I ORDERITEM'="" I RY=0 D
 ...........S RY="ERR="_"Orderable item found in Non-Orderable dialog element "_DIALOGN
 ..........I ORDERITEM'="" Q
 ..........S FINDING=$P($G(^PXRMD(801.41,DIALOGEL,1)),U,5) I FINDING'="" I RY=0 D   ;check piece 5 ? for FINDNG OR order dialog ******
 ...........S RY="ERR="_"Finding item found in Non-Orderable dialog element. "_DIALOGN
 ..........I FINDING'="" Q
 ..........S FOLLUPCT=0
 ..........S OVER=1
 ..........F  S FOLLUPCT=$O(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT)) Q:(FOLLUPCT="")!(FOLLUPCT="B")  D
 ...........S FOLLOWAC=$P($G(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT,0)),"^",1)  ;DYNAMIC POINTER
 ...........;LOOK FOR V HEALTH FACTOR TYPE ONLY
 ...........;GET FOLLOUP ACTION HEALTH FACTOR AS ADDITIONAL FINDING TYPE IN FORM "500156;AUTTHF(" WHERE NUMERIC LIKE 500156 IS INTERNAL # FOR HEALTH FACTOR ENTRY
 ...........I FOLLOWAC["AUTTHF(" D
 ............S COUNTER1=COUNTER1+1
 ............S ^TMP($J,"FOLLOWUPITEM",COUNTER1)=FOLLOWAC
 ............;WRITE HF ONLY INTO ALERT TYPE FILE HERE
 ............I (OVER=0)!(OVER=2) D
 .............S OVER=2
 ............E  D
 .............S OVER=0
 .............S FOLLHEAL=$P(FOLLOWAC,";",1)
 .............I FOLLHEAL'="" S FOLLHEAL=$P($G(^AUTTHF(FOLLHEAL,0)),"^",1) ;;GOW ADDED 2/8/2014
 ..........I OVER=1 D
 ...........I RY=0 S RY="ERR="_"NO HEALTH FACTOR FOUND AS ADDITIONAL FINDING IN DIALOG ELEMENT "_DIALOGN
 ..........;I OVER=2 D
 ..........;.I RY=0 S RY="ERR="_"MULTIPLE HEALTH FACTORS FOUND AS ADDITIONAL FINDING IN DIALOG ELEMENT "_DIALOGN
 ..........;I (OVER=1)!(OVER=2) Q
 ..........I (OVER=1) Q
 ..........;NOW WRITE CORRECT VALUES UP TO AND INCLUDING HEALTH FACTOR FOUND AS ADDITIONAL FINDING
 ..........K FDA,FDAIEN,OROUT
 ..........S FILE=ORDRFOLU ; ORDER OR FOLLOW UP ACTION MULTIPLE
 ..........S IENS=ALERTGEN_","_IEN_","
 ..........S FDA(46,FILE,IENS,.01)=BOXTEXT
 ..........S FDA(46,FILE,IENS,4)=FOLLHEAL  ;
 ..........D FILE^DIE("","FDA(46)","OROUT(46)")
 ..........I $D(OROUT(46,"DIERR")) I RY=0 S RY="ORDER/FOLLOW-UP/COMMENT GROUP ENTRY ERROR= "_BOXTEXT_" "_OROUT(46,"DIERR",1,"TEXT",1) S OVER=1 K FDA(46),OROUT(46) Q
 ..........K FDA(46),OROUT(46)
 I RY=0 S RY="OK ALL VALIDITY CHECKS PASSED"
 Q
 ;
NAME(DA1,X) ;
 ;NAME OF DESIRED ELEMENT NAME IN ALERT TYPE FILE ENTRY'S ORDERS/FOLLOWUP/COMMENTS MULTIPLE ENTRY
 ;SET X ="AW"_(ORIGINAL SITE NO) (ALERT TYPE MNEUMONIC) X
 ;I.E. X=ORDER PSA AGAIN , S X="AW500 PSA ORDER PSA AGAIN
 ;
 ;
 I X'[("AW"_$P($G(^DIZ(19007,DA1,3)),"^",8)_" "_$P($G(^DIZ(19007,DA1,3)),"^",9)) S X="AW"_$P($G(^DIZ(19007,DA1,3)),"^",8)_" "_$P($G(^DIZ(19007,DA1,3)),"^",9)_" "_X
 Q X
CHKNAME(DA1,X) ;
 N RET
 S RET=X
 ;S RET=0
 ;CHECK ALERT TYPE FILE ENTRY'S ORIGINAL SITE NO AND ALERT TYPE MNEUMONIC. IF "" RETURN 1
 ;I ($P($G(^DIZ(19007,DA1,3)),"^",8)="")!($P($G(^DIZ(19007,DA1,3)),"^",9)="") S RET=1
 I X'[("AW"_$P($G(^DIZ(19007,DA1,3)),"^",8)_" "_$P($G(^DIZ(19007,DA1,3)),"^",9)) S RET=""
 Q RET
CHKNOTI(DA,X) ;
 N RET
 S RET=1
 ;COULD EXPAND LIST LATER, BUT SOME PROBABLY SOME NOT APPLICABLE. COME FROM OE/RR NOTIFICATIONS FILE 
 ;CHECK CRITICAL ALERT CATEGORY FILE ENTRY TO BE EITHER BE   NF_ABNORMAL_IMAGING_RESULTS      = 25; OR NF_CRITICAL_LAB_RESULTS          = 57; FOR NOW
 ;I (($P($G(^DIZ(19008,DA,1)),"^",2)=25)!($P($G(^DIZ(19008,DA,1)),"^",2)=57)) S RET=0
 I (X=25)!(X=57) S RET=0
 Q RET
GETNOTF(RET) ; Return list of Notification Type
 K RET N NOTF
 F NOTF=25,57 D
 . S RET(NOTF)=$P($G(^ORD(100.9,NOTF,0)),U)
 Q
REMDIAL(X)	;
 N TYPE,RET
 S RET=0
 S TYPE=""
 I X'="" S TYPE=$P($G(^PXRMD(801.41,X,0)),"^",4)
 I TYPE'="R" S RET=1
 ;S ^XTMP("GE")=X
 Q RET
INITDAT(DA)	;
 N RET
 S RET=0
 ;PREVENT OVERRIDE OF INITIALIZATION OF INITDATE FOR ALERT TYPE
 I $P($G(^DIZ(19007,DA,3)),"^",4)'="" S RET=1
 Q RET
GETPROG(REC)	;
 N COUNT,COUNTS
 K ^TMP($J,"PROGNOTE")
 S COUNTS=0
 S COUNT=0 F  S COUNT=$O(^PXRMD(801.41,REC,25,COUNT)) Q:COUNT=""  D
 .S ^TMP($J,"PROGNOTE",COUNT)=$G(^PXRMD(801.41,REC,25,COUNT,0))
 .S COUNTS=COUNT
 S ^TMP($J,"PROGNOTE","COUNT")=COUNTS
 Q
WRITPROG(REC,SUBVAL,IENP)
 N COUNT,SUBREC,ICOUNTS
 I SUBVAL="19007.01" S SUBREC=1
 I SUBVAL="19007.02" S SUBREC=2
 I SUBVAL="19007.03" S SUBREC=4
 S COUNT=$G(^TMP($J,"PROGNOTE","COUNT"))
 I COUNT=0 D
 .K ^DIZ(19007,REC,SUBREC,IENP,2)
 .I SUBVAL="19007.01" S ^DIZ(19007,REC,SUBREC,IENP,2,0)="^19007.15^^^"
 .I SUBVAL="19007.02" S ^DIZ(19007,REC,SUBREC,IENP,2,0)="^19007.25^^^"
 .I SUBVAL="19007.03" S ^DIZ(19007,REC,SUBREC,IENP,2,0)="^19007.35^^^"
 E  D
 .S ICOUNTS=""
 .K ^DIZ(19007,REC,SUBREC,IENP,2)
 .S ICOUNT=0 F  S ICOUNT=$O(^TMP($J,"PROGNOTE",ICOUNT)) Q:(ICOUNT="")!(ICOUNT="COUNT")  D
 ..S ^DIZ(19007,REC,SUBREC,IENP,2,ICOUNT,0)=$G(^TMP($J,"PROGNOTE",ICOUNT))
 ..S ICOUNTS=ICOUNT
 .I SUBVAL="19007.01" S ^DIZ(19007,REC,SUBREC,IENP,2,0)="^19007.15^"_ICOUNTS_"^"_ICOUNTS_"^"_DT_"^"
 .I SUBVAL="19007.02" S ^DIZ(19007,REC,SUBREC,IENP,2,0)="^19007.25^"_ICOUNTS_"^"_ICOUNTS_"^"_DT_"^"
 .I SUBVAL="19007.03" S ^DIZ(19007,REC,SUBREC,IENP,2,0)="^19007.35^"_ICOUNTS_"^"_ICOUNTS_"^"_DT_"^"
 K ^TMP($J,"PROGNOTE")
 Q
TEST	;
 D GETPROG(495)  ; GET PROGRESS NOTE TEXT FROM REMINDER DIALOG ELEMENT
 D WRITPROG(2,"19007.01",2) ;WRITE INTO ALERT TYPE FILE
Q 
ALERT2(X) ;D0 AS X
 N VEFACNT,VEFACAT,VEFANOTF,VEFACATY,VEFAALNT,VEFADSPL,VEFACATN,VEFAUTCA,VEFAENTR,VEFANAME
 N D0
 S D0=X
 S VEFACATN=""
 S VEFANAME=""
 S VEFACATY=0  ; NOT CATEGORY CLASS
 ;GET NOTIFICATION TYPE FOR THIS ALERT
 S VEFAALNT=$P($P($P($G(^XTV(8992.1,D0,0)),"^",1),";",1),",",3)
 ;GET DISPLAY EXT THIS TYPE OF ALERT
 S VEFADSPL=$P($G(^XTV(8992.1,D0,1)),"^",1)
 S VEFACAT=0
 F  S VEFACAT=$O(^DIZ(19008,"B",VEFACAT)) Q:(VEFACAT="")!(VEFACATY=1)  D
 .S VEFACNT=0
 .S VEFACNT=$O(^DIZ(19008,"B",VEFACAT,VEFACNT)) D
 ..;GET NOTIFICATION TYPE
 ..S VEFANOTF=$P($G(^DIZ(19008,VEFACNT,1)),"^",2)
 ..I VEFANOTF=VEFAALNT D
 ...I VEFACATY'=1 S VEFACATY=2
 ...S VEFACATN=$P($G(^DIZ(19008,VEFACNT,0)),"^",1)
 ...I VEFADSPL[VEFACATN D
 ....I VEFACATY'=1 S VEFACATY=3
 ....; LOOP THROUGH UNIQUE VEFA TRACKED CRITICAL ALERTS
 ....S VEFAUTCA=0
 ....F  S VEFAUTCA=$O(^DIZ(19007,"B",VEFAUTCA)) Q:(VEFAUTCA="")!(VEFACATY=1)  D
 .....;GET ENTRY
 .....S VEFAENTR=0
 .....S VEFAENTR=$O(^DIZ(19007,"B",VEFAUTCA,VEFAENTR))
 .....S VEFANAME=$P(^DIZ(19007,VEFAENTR,0),"^",1)
 .....I VEFADSPL[VEFANAME S VEFACATY=1
 I (VEFACATY=2)!(VEFACATY=3) S VEFACATY=0
 Q VEFACATN_"^"_VEFANAME
ORDERCK2(X) ;
 ;RETURN LIST OF ORDER FOLLOWUP ACTION THAT HAVE BEEN DONE. FROM ACKNOWLEDGED (DELETED) ALERT DATE TIME OR CURENT TIME BACK TO DATE OF ALERT
 N D0,RY,VEFADFN,VEFAPRV,VEFADTIM,VEFARETN,VEFAFOLP,ZP,RY,VEFADSPL,VEFADELD
 N VEFANAME
 S D0=X
 S VEFADFN=$P($G(^XTV(8992.1,D0,0)),"^",4)
 S VEFADTIM=$P($P($G(^XTV(8992.1,D0,0)),"^",1),";",3)
 S VEFARETN=$$SERVIC1^VEFAALR1(X)
 S VEFANAME=$P(VEFARETN,"^",3)
 S VEFAPRV=$P(VEFARETN,"^",2)
 S VEFADSPL=$P($G(^XTV(8992.1,D0,0)),"^",1)
 ;W !,"VEFADSPL=",VEFADSPL
 ;GET ACKNOWLEDGED(DELETED) DATE (IF ANY)
 S VEFADELD=$$STATUS1^VEFAALR1(X)
 S VEFADELD=$P(VEFADELD,"^",3)
 S ZP=VEFADFN_"^"_VEFAPRV_"^"_VEFANAME_"^"_VEFADTIM_"^"_VEFADELD
 ;W !,"ZP=",ZP
 S RY=""
 D LKPORDCK^VEFAALR4(.RY,ZP)  ;Do a lookup for specific critical alert TYPE, and associated date/time of a real unacknowledged alert,and RETURN list of 
 ;any ORDERS by ordering provider user (DUZ) that have been made from list of available FAT (Follow-up Alert Tracking) orders in in specifi defined VEFA ALERT TRACKING entry's Reminder Dialog 
 ; multiples(and fields)with a Reminder Dialog, the dialog elements thereof containing the ORDER types (orderable iems) for such list 
 ;to be compared with any actual orders NOT by any ordering provider user(s) (DUZ) made after the date/time of the actual critical alert UP to NOW or
 ;to date of acknowledgement(deletion) OR now time (if not passed). Do this search in reverse chronological order.
 ;First Verify also that type of alert passed is in VEFA ALERT TRACKING file for "followup" purposes, and has defined REMINDER DIALOG
 ; INPUT 
 ;  ZP = DFN ^ DUZ ^ TYPE OF ALERT ^ DATE/TIME OF UNACK CRIT ALERT ^ DATE ACKNOWLEDGED(DELETED) 
 ; RETURN
 ;  RY= ORDERING PROVIDER OF ORDER/FOLLOW-UP ACTION (IF ANY) THEN "*" AND ACKGT7D FLAG(0 OR 1) THEN "*" AND * FOLLGT7D ( 0 OR 1))
 ;  FOLLOWED BY ";" AND THEN CONCATENATED STRING OF ACTUAL ORDERS MADE EACH SEPARATED WITH ";"
 ;  EACH FOLLOWED UP ACTION HAS SECONDARY PIECE DELIMITED BY '*" FOR DATE/TIME OF FOLLOWUP ACTION ACTIVITY
 ;
 Q RY
LKPORDCK(RY,ZP) ;Do a lookup for specific critical alert TYPE, and associated date/time of a real unacknowledged alert,and RETURN list of 
 ;any ORDERS by ordering provider user (DUZ) that have been made from list of available FAT (Follow-up Alert Tracking) orders in in specifi defined VEFA ALERT TRACKING entry's Reminder Dialog 
 ; multiples(and fields)with a Reminder Dialog, the dialog elements thereof containing the ORDER types (orderable iems) for such list 
 ;to be compared with any actual orders by ordering provider user(s) (DUZ) made after the date/time of the actual critical alert UP to NOW or
 ;to date of acknowledgement(deletion) OR now time (if not passed). Do this search in reverse chronological order.
 ;First Verify also that type of alert passed is in VEFA ALERT TRACKING file for "followup" purposes, and has defined REMINDER DIALOG
 ; INPUT 
 ;  ZP = DFN ^ DUZ ^ TYPE OF ALERT ^ DATE/TIME OF UNACK CRIT ALERT ^ DATE ACKNOWLEDGED(DELETED) 
 ; RETURN
 ;  RY= (PROVIDER FOR ORDERS/FOLLOW-UPS * ACKGT7D FLAG(0 OR 1) * FOLLGT7D ( 0 OR 1)) * REVERST1 (FOLOWUP(S) DONE) ; THEN (CONCATENATED STRINGS OF ACTUAL ORDERS/FOLLOWUPS * DATE/TIMEOF SUCH) EACH SPEARATED WITH ";"
 ;
 ;
 N VEFADFN,VEFADUZ,VEFAALRT,VEFAADTT,VEFARMDL
 N VEFACNT,VEFACNT1,VEFACNT2
 N DISABLE,REMDIALG,DIALOGTY,DIALOGEL,RESOLTYP,ORDRITM,COUNTER,CNTORD,CNT1,ORDER,CNTTIMO,CNTTIMA,REVERST,CNTPAT,ORDERCK,COUNTERF
 N RYY,ACTION,ACTIONK,SIGSTAT
 N DELETEDT,ORDRITEM
 N FOLLUPCT,FOLLOWAC
 N VHEALTH,OVERFLAG,VHEALF,FOLLOWUP,VISITPTR
 N FOLLOWU1
 N AGENTPRM,AGENTPRV,COUNTER1,ACTIVE
 N ACKGT7D,REVERST1,FOLLGT7D
 N VHEALFT
 N INITDATE
 ;K RY
 S RY=0
 S AGENTPRV=""
 S COUNTER=0
 S COUNTER1=0
 K ^TMP($J,"ORDERITEM")
 K ^TMP($J,"FOLLOWUPITEM")
 K ^TMP($J,"ORDERITEMFOUND")
 S VEFADFN=$P(ZP,U,1) S VEFADUZ=$P(ZP,U,2) S VEFAALRT=$P(ZP,U,3) S VEFAADTT=$P(ZP,U,4) S DELETEDT=$P(ZP,U,5)
 ;
 ;first CHECK if type of alert if in VEFA ALERT TRACKING file
 S VEFACNT=0
 ;
 S VEFACNT=$O(^DIZ(19007,"B",VEFAALRT,VEFACNT))
 S ACTIVE=0
 S INITDATE=0
 ;CHECK IF ACTIVE
 ;S VEFACNT=$O(^DIZ(19007,"B",VEFAALRT,VEFACNT))
 I VEFACNT'="" D
 .S ACTIVE=$P($G(^DIZ(19007,VEFACNT,3)),"^",5)
 .I ACTIVE="" S ACTIVE=0
 .S INITDATE=$P($G(^DIZ(19007,VEFACNT,3)),"^",4)
 .I INITDATE="" S INITDATE=0
 ;I (VEFACNT'="")&(ACTIVE) D
 I (VEFACNT'="")&(INITDATE'=0)&(VEFAADTT>INITDATE) D
 .;
 .; RECORD # in VEFA TRACKED ALERTS file
 .; get reminder dialog 
 .S VEFARMDL=$P($G(^DIZ(19007,VEFACNT,3)),U,1) ;
 .I VEFARMDL'="" D
 ..;
 ..;GO TO FILE 801.41
 ..;CHECK IF DISABLED
 ..S DISABLE=$P($G(^PXRMD(801.41,VEFARMDL,0)),U,3)
 ..;I (DISABLE=0)!(DISABLE="") D
 ..D
 ...;
 ...;CHECK REMINDER TYPE AS "REMINDER DIALOG"
 ...S REMTYPE=$P($G(^PXRMD(801.41,VEFARMDL,0)),U,4)
 ...I REMTYPE="R" D
 ....;
 ....; LOOK THROUGH DIALOG GROUPS AND THEIR ELEMENTS TO FIND ORDERABLE ANY ORDER ITEMS.
 ....S VEFACNT=0
 ....F  S VEFACNT=$O(^PXRMD(801.41,VEFARMDL,10,"B",VEFACNT)) Q:VEFACNT=""  D
 .....;GET INTERNAL ENTRY #
 .....S VEFACNT1=0
 .....S VEFACNT1=$O(^PXRMD(801.41,VEFARMDL,10,"B",VEFACNT,VEFACNT1))
 .....;
 .....I VEFACNT1'="" D
 ......; GET DIALOG GROUP OR DIRECT DIALOG ELEMENT (ASSUME FOR NOW ONLY DIALOG GROUP WITH ORDERS)
 ......S REMDIALG=$P($G(^PXRMD(801.41,VEFARMDL,10,VEFACNT1,0)),U,2)
 ......;
 ......I REMDIALG'="" D
 .......; CHECK IF DIALOG GROUP
 .......S DIALOGTY=$P($G(^PXRMD(801.41,REMDIALG,0)),U,4)
 .......I DIALOGTY="G" D   ; DIALOG GROUP
 ........;
 ........S VEFACNT2=0 ; GET DIALOG ELEMENTS INSIDE THIS DIALOG GROUP
 ........F  S VEFACNT2=$O(^PXRMD(801.41,REMDIALG,10,"B",VEFACNT2)) Q:VEFACNT2=""  D
 .........;GET INTERNAL ENTRY #
 .........S DIALOGEL=0
 .........S DIALOGEL=$O(^PXRMD(801.41,REMDIALG,10,"B",VEFACNT2,DIALOGEL))
 .........; DIALOG ELEMENT
 .........;
 .........S DIALOGEL=$P($G(^PXRMD(801.41,REMDIALG,10,DIALOGEL,0)),U,2)
 .........;
 .........;CHECK "ORDER" RESOLUTION TYPE FIRST
 .........S RESOLTYP=$P($G(^PXRMD(801.41,DIALOGEL,1)),U,3)
 .........I RESOLTYP=3 D
 ..........;GET ORDERABLE ITEMS FILE ENTRY AS POOSIBLE FOLLOW-UP ACTION CHOICE. STORE INTO ^TMP($J,"ORDERITEM,COUNTER) ARRAY
 ..........S ORDERITEM=$P($G(^PXRMD(801.41,DIALOGEL,1)),U,7)
 ..........; NOW LOOK AT ORDERS IF ANY AND CHECK DATE/TIME > DATE/TIME OF PASSED CRIT ALERT
 ..........S COUNTER=COUNTER+1
 ..........;
 ..........S ^TMP($J,"ORDERITEM",COUNTER)=ORDERITEM
 ..........;new section to allow health factor to resolve with non-specific orderable item (like anti-biotics in general)
 ..........S FOLLUPCT=0
 ..........F  S FOLLUPCT=$O(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT)) Q:(FOLLUPCT="")!(FOLLUPCT="B")  D
 ...........S FOLLOWAC=$P($G(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT,0)),"^",1)  ;DYNAMIC POINTER
 ...........;LOOK FOR V HEALTH FACTOR TYPE ONLY
 ...........;GET FOLLOUP ACTION HEALTH FACTOR AS ADDITIONAL FINDING TYPE IN FORM "500156;AUTTHF(" WHERE NUMERIC LIKE 500156 IS INTERNAL # FOR HEALTH FACTOR ENTRY
 ...........I FOLLOWAC["AUTTHF(" D
 ............S COUNTER1=COUNTER1+1
 ............S ^TMP($J,"FOLLOWUPITEM",COUNTER1)=FOLLOWAC
 ..........;end section
 .........E  D
 ..........S FOLLUPCT=0
 ..........F  S FOLLUPCT=$O(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT)) Q:(FOLLUPCT="")!(FOLLUPCT="B")  D
 ...........S FOLLOWAC=$P($G(^PXRMD(801.41,DIALOGEL,3,FOLLUPCT,0)),"^",1)  ;DYNAMIC POINTER
 ...........;LOOK FOR V HEALTH FACTOR TYPE ONLY
 ...........;GET FOLLOUP ACTION HEALTH FACTOR AS ADDITIONAL FINDING TYPE IN FORM "500156;AUTTHF(" WHERE NUMERIC LIKE 500156 IS INTERNAL # FOR HEALTH FACTOR ENTRY
 ...........I FOLLOWAC["AUTTHF(" D
 ............S COUNTER1=COUNTER1+1
 ............S ^TMP($J,"FOLLOWUPITEM",COUNTER1)=FOLLOWAC
 ....;  NOW GET ORDERS BY PATIENT AND PROVIDER (DUZ) DOESN'T CARE AS ORDER COULD BE MADE AMONG ANY PROVIDER IN OE/RR GROUP DEFINED
 ....; 
 ....; FOR SPECIFIC CRIT ALERT PROCESSING.BUT SHOULD MOST LIKELY BE MADE BY ORDERING PROVIDER. GET ORDERS STARTING IN REVERSE TIME
 ....; ORDER UNTIL DATE/TIME OF ANY ORDER < 
 ....;DATE/TIME OF CRIT ALERT,OR NO ORDER FOUND IS ENCOUNTERED. SEARCH AMONG ORDERITEM LIST F FOUND BEFORE END OF SEARCH IS OVER.
 ....;GO BY PATIENT FIRST
 ....S CNTTIMO=0  ; DATE/TIME OF ORDER ABD CNTTIMA DATE/TIME OF UNACK CRIT ALERT
 ....S CNTPAT=VEFADFN_";DPT("
 ....;
 ....;W !
 ....;ZW ^TMP($J,"ORDERITEM")
 ....;S COUNTERF=0  ; COUNTER OF ORDERS FOUND
 ....;if ACK DATE AS DELETEDT'="" THEN FIGURE IF DELETEDT >ACK DATE+7 DAYS
 ....;SAME FOR EARLIEST FOLLOWUP ORDER DATE(S). INITIALIZE BELOW
 ....S REVERST1=""
 ....;I DELETEDT'="" S X1=DELETEDT S X2=-7 I VEFAADTT<X S ACKGT7D=1 E  S ACKGT7D=0
 ....S ACKGT7D=0 ; DEFAULT EVEN W/O DELETEDT DATE YET. CHECK ID ALREADY 7 DAYS PASS (IF SO MAK ACKGT7D=1)
 ....D NOW^%DTC S X1=% S X2=-7 D C^%DTC I VEFAADTT<X S ACKGT7D=1
 ....I DELETEDT'="" S X1=DELETEDT S X2=-7 D C^%DTC S ACKGT7D=0 I VEFAADTT<X S ACKGT7D=1
 ....S OVERFLAG=0
 ....F  S CNTTIMO=$O(^OR(100,"AC",CNTPAT,CNTTIMO)) S REVERST=9999999-CNTTIMO Q:(CNTTIMO="")!(VEFAADTT>REVERST)!(OVERFLAG=1)  D
 .....;CHECK ONLY IS LESS THAN DELETED DATE/TIME IF PASSED
 .....I DELETEDT'="" I '(REVERST<DELETEDT) Q
 .....I VEFAADTT>REVERST S OVERFLAG=1 Q
 .....S ORDER=0
 .....S ORDER=$O(^OR(100,"AC",CNTPAT,CNTTIMO,ORDER))
 .....;
 .....;
 .....I ORDER'="" D
 ......;S AGENTPRM=$P($G(^OR(100,D0,0)),"^",4) ; MAYBE PROVIDER
 ......S CNT1=0 ; SEARCH MULTIPLE ORDERABLE ITEMS WITHIN 1 ORDER
 ......F  S CNT1=$O(^OR(100,ORDER,.1,"B",CNT1)) Q:(CNT1="")  D
 .......S CNTORD=CNT1
 .......;
 .......;S CNTORD=$P($G(^OR(100,ORDER,.1,CNT1,0)),"^",1)
 .......;CHECK AMONG ALL ACTUAL ORDERABLE ITEMS OF ORDER AMONG LIST OF ORDERABLE ITEMS FOR FOLLOW-UP ACTION.LIST ONLY ONE OCCURENCE IN ARRAY
 .......S COUNTER=0
 .......F  S COUNTER=$O(^TMP($J,"ORDERITEM",COUNTER)) Q:COUNTER=""  D
 ........S ORDERCK=$G(^TMP($J,"ORDERITEM",COUNTER))
 ........;
 ........I ORDERCK=CNTORD D
 .........;S AGENTPRV=$P($G(^OR(100,D0,0)),"^",4) ; ACTUAL AGENT PROVIDER OF ORDER
 .........S RYY=2  ; FOUND
 .........;ORDERABLE ITEM NAME
 .........I ORDERCK'="" D
 ..........S ORDRITEM=$P($G(^ORD(101.43,ORDERCK,0)),"^",1)
 ..........S ^TMP($J,"ORDERITEMFOUND",ORDRITEM_"*"_REVERST)=""
 ..........S REVERST1=REVERST  ; GO BACK IN REVERSE TIME. SAVE OLDEST ORDER/FOLLOWUP TIME FOUND ( UP TO DELETED /ACKED DATE IF ANY) 
 ..........I ($P($G(^OR(100,ORDER,0)),"^",4)'="")&(AGENTPRV="") S AGENTPRV=$P($G(^OR(100,ORDER,0)),"^",4) ; ACTUAL AGENT PROVIDER OF ORDER
 ..........;W !,"AGENTPRV=",AGENTPRV
 .........S SIGSTAT=1
 .........;NOT CHECK IF SIGNATURE REQUIRED AND SIGNATURE ITSELF
 .........I $P($G(^OR(100,ORDER,0)),"^",16)=2 D      ;ORES
 ..........S ACTION=0
 ..........S SIGSTAT=0
 ..........F  S ACTION=$O(^OR(100,ORDER,8,ACTION)) Q:(ACTION="")!(ACTION="C")  D
 ...........S ACTIONK=ACTION
 ...........S SIGSTAT=$P($G(^OR(100,ORDER,8,ACTION,0)),"^",4)
 ..........; CHECK FOR SIG STAT=1 FOR SIGNED ORDER ("ELECTRONIC") 
 ..........I RY'[1 S RY=RYY_"^"_SIGSTAT  ;SIGSTAT = 1 MEANS NO SIG REQUIRED OR SIG REQUIRED AND FOUND 
 .........E  D
 ..........S RY=RYY_"^"_1
 .........;
 ......;
 ......I RY'=0 I RY'[1 S RY=0_"^"_3      ; IE. IF RY NOT= 2_"^"_1 S RY=0_"^"_3
 ....;
 ....D
 .....;
 .....;  NOW GET V HEALTH FACTORS BY PATIENT 
 .....; FOR SPECIFIC CRIT ALERT PROCESSING.GET V HEALTH FACTORS STARTING IN REVERSE TIME ORDER 
 .....;UNTIL DATE/TIME OF ANY FOLLOWUP ACTION (V HEALTH FACTOR)< 
 .....;DATE/TIME OF CRIT ALERT,OR NO V  HEALTH FACTOR FOUND IS ENCOUNTERED. SEARCH AMONG FOLLOWUP LIST FOUND BEFORE END OF SEARCH IS OVER.
 .....;GO BY PATIENT FIRST
 .....S VHEALTH=999999999999
 .....S OVERFLAG=0
 .....;W !
 .....;ZW ^TMP($J,"FOLLOWUPITEM")
 .....F  S VHEALTH=$O(^AUPNVHF("C",VEFADFN,VHEALTH),-1) Q:(VHEALTH="")!(OVERFLAG=1)  D
 ......S VISITPTR=$P($G(^AUPNVHF(VHEALTH,0)),"^",3)
 ......I VISITPTR'="" S REVERST=$P($G(^AUPNVSIT(VISITPTR,0)),"^",1)
 ......;
 ......;
 ......I VEFAADTT>REVERST S OVERFLAG=1 Q
 ......I DELETEDT'="" I '(REVERST<DELETEDT) Q
 ......S VHEALFT=$P($G(^AUPNVHF(VHEALTH,0)),"^",1)
 ......;;;;;I VHEALFT=500158 S ^XTMP("AAA4","500158")=VEFADFN_"^"_VHEALTH
 ......;CHECK IF THIS HEALTH FACTOR WITHIN DATE/TIME ALLOWED IS ONE OF FOLLOWUP ACTION HEALTH FACTORS
 ......S COUNTER1=0
 ......F  S COUNTER1=$O(^TMP($J,"FOLLOWUPITEM",COUNTER1)) Q:(COUNTER1="")  D
 .......S FOLLOWUP=$G(^TMP($J,"FOLLOWUPITEM",COUNTER1))
 .......;S ^XTMP("AAAA",COUNTER1)=FOLLOWUP_"^"_VHEALFT
 .......I FOLLOWUP[VHEALFT D
 ........S FOLLOWU1=$P(FOLLOWUP,";",1)
 ........I FOLLOWU1'="" D
 .........S FOLLOWU1=$P($G(^AUTTHF(FOLLOWU1,0)),"^",1)
 .........I ($P($G(^AUPNVHF(VHEALTH,12)),"^",4)'="")&(AGENTPRV="") S AGENTPRV=$P($G(^AUPNVHF(VHEALTH,12)),"^",4) ;
 .........;W !,"AGENTPRV=",AGENTPRV
 .........S ^TMP($J,"ORDERITEMFOUND",FOLLOWU1_"*"_REVERST)=""  ; S RY=2_"^"_1
 .........S REVERST1=REVERST  ; GO BACK IN REVERSE TIME. SAVE OLDEST ORDER/FOLLOWUP TIME FOUND ( UP TO DELETED /ACKED DATE IF ANY) 
 ....;
 ....;
 ....;
 ....;
 ...E  D
 ....S RY=3_"^"_3  ; MEANS NO REMINDER DIALOG FOUND A SDIALOG ELEMENT NOT A REMINDER TYPE
 .E  D
 ..S RY=3_"^"_3  ; MEANS NO REMINDER DIALOG FOUND
 E  D
 .S RY=3_"^"_2  ; MEANS NO ALERT TRACKING FILE ENTRY FOUND FOR THIS TYPE OF ALERT
 I ($P(RY,"^",1)=3)&(($P(RY,"^",2)=3)!($P(RY,"^",2)=2)) Q 
 ;DO LOOP OF ORDERS FOUND RETURNED CONCATENATED WITH ";"
 S FOLLGT7D=0 ; DEFAULT EVEN W/O REVERST1 DATE YET. CHECK IF ALREADY 7 DAYS PASS (IF SO MAKE FOLLGT7D=1)
 D NOW^%DTC S X1=% S X2=-7 D C^%DTC I VEFAADTT<X S FOLLGT7D=1
 I ($D(REVERST1)) D
 . I REVERST1'="" S X1=REVERST1 S X2=-7 D C^%DTC S FOLLGT7D=0 I VEFAADTT<X S FOLLGT7D=1
 S RY=""
 S RY=$G(AGENTPRV)_"*"_$G(ACKGT7D)_"*"_$G(FOLLGT7D)_"*"_$G(REVERST1)_";"
 S COUNTERF=0
 F  S COUNTERF=$O(^TMP($J,"ORDERITEMFOUND",COUNTERF)) Q:COUNTERF=""  D
 .S RY=RY_COUNTERF_";"
 Q
VALIDTYP(Y) ; SCREEN ON KIDS BUILD TO RETURN VALID VEFA TRACKED CRITICAL ALERT TYPES
 ;I $P($G(^DIZ(19007,Y,0)),"^",1)="[PROSTATE SPECIFIC ANTIGEN]" Q 1
 ;I $P($G(^DIZ(19007,Y,0)),"^",1)="[OCCULT BLOOD]" Q 1
 ;I $P($G(^DIZ(19007,Y,0)),"^",1)="CHEST 2 V" Q 1
 I $P($G(^DIZ(19007,Y,0)),"^",1)="MAMMOGRAM" Q 1
 Q 0
VALIDCAT(Y) ; SCREEN ON KIDS BUILD TO RETURN VALID VEFA ALERT CATEGORIES
 I $P($G(^DIZ(19008,Y,0)),"^",1)="Abnl Imaging Reslt, Needs Attn:" Q 1
 I $P($G(^DIZ(19008,Y,0)),"^",1)="Critical labs -" Q 1
 Q 0
ALERTVAL(D0)	;
 N RET,ALERTDT,ALERTSDT,ALERTEDT,DISPLYTX,TEST,DFN,TYPLAB,TESTDT
 ;GET ALERT DATE/TIME
 ;ALERT ID REPRESENTATION AS IN "OR,3,57;20364;3140209.164349"
 ;GET NOTIFICATION TYPE
 ; IF CRITICAL LABS USE LAB API TO RETURN ALERT VALUES
 S RET=""
 S DISPLYTX=$P($G(^XTV(8992.1,D0,1)),"^",1)
 S DFN=$P($G(^XTV(8992.1,D0,0)),"^",4)
 I DISPLYTX["Critical labs -" D
 .;
 .K ^TMP("LRRR",$J)
 .S TEST=$P(DISPLYTX,"[",2) S TEST=$P(TEST,"]",1)
 .S TYPLAB=$P($G(^XTV(8992.1,D0,2)),";",4)  ; IE CH,MI,AP,BB ETC
 .S ALERTEDT=$P($G(^XTV(8992.1,D0,2)),";",5) S ALERTEDT=$P(ALERTEDT,"@",1) ;REVERSE TIME
 .S TESTDT=ALERTEDT
 .;CONVERT TO REGULAR DATE/TIME
 .S X1=9999999 S X1=X1-ALERTEDT S ALERTSDT=X1 S X2=.01 D C^%DTC S ALERTEDT=X
 .S X1=ALERTSDT S X2=-.01 D C^%DTC S ALERTSDT=X
 .;W !,"DFN=",DFN," ALERTSDT=",ALERTSDT," ALERTEDT=",ALERTEDT," TYPLAB=",TYPLAB," TEST=",TEST
 .;D RR^LR7OR1(DFN,,SDATE,EDATE,"CH",TEST,,,,)
 .;D NOW^%DTC S ALERTEDT=%
 .D RR^LR7OR1(DFN,,ALERTSDT,ALERTEDT,TYPLAB,TEST,,,,)
 .;W !
 .;ZW ^TMP("LRRR",$J)
 .S ITEM=0
 .F  S ITEM=$O(^TMP("LRRR",$J,DFN,"CH",TESTDT,ITEM)) Q:(ITEM="")!(ITEM="N")  D
 ..S RET=$P($G(^TMP("LRRR",$J,DFN,"CH",TESTDT,ITEM)),"^",2)_" "_$P($G(^TMP("LRRR",$J,DFN,"CH",TESTDT,ITEM)),"^",3)
 .;S RET=
 .;I (RET'="")&(TEST="PROSTATE SPECIFIC ANTIGEN") S RET="PSA POSITIVE"  ; SINCE SIMULATED LAB TESTER USES NUMERIC VALUES 
 .I (RET'="")&(TEST="OCCULT BLOOD") S RET="POSITIVE"  ; SINCE SIMULATED LAB TESTER USES NUMERIC VALUES 
 .;AS METHOD FOR GENERATING ALERTS. IN PRODUCTION RESULTS WILL ALREADY BE ASCII VALUE "POSITIVE" NOT NUMERIC VALUE
 .K ^TMP("LRRR",$J)
 ;ABNORMAL IMAGING SET BELOW
 I DISPLYTX["Abnl Imaging Reslt, Needs Attn:" S RET="ABNORMAL"
 Q RET
DELCACHE	;
 N EXTSTDAT,IEN,OVER,WINDOW,PRSTDATE,DATETIME,FLAG
 ;DELETE ENTRIES WHOSE DATE/TIME IS LESS THAN (NOW DATE/TIME-CACHE WINDOW OF OPPORTUNITY)
 ; 
 ;READ START EXTRACTION DATE BASED ON CACHE WINDOW 
 ;
 S WINDOW=$P($G(^DIZ(19008.1,1,0)),"^",3)
 W !,"WINDOW=",WINDOW
 I WINDOW="" Q
 D NOW^%DTC S PRSTDATE=%
 S X1=PRSTDATE,X2=-(WINDOW+1) D C^%DTC S EXTSTDAT=X
 ;S EXTSTDAT=$P($G(^DIZ(19008.1,1,0)),"^",6)
 W !,"EXTSTDAT=",EXTSTDAT," PRSTDATE=",PRSTDATE
 I EXTSTDAT="" Q
 S OVER=0
 S DATETIME=0
 S FLAG=0
 W !,"EXTSTDAT=",EXTSTDAT," PRSTDATE=",PRSTDATE
 F  S DATETIME=$O(^DIZ(19008.2,"C",DATETIME)) Q:(DATETIME="")!(OVER)  D
 .I DATETIME>EXTSTDAT S OVER=1 Q
 .S IEN=0 S IEN=$O(^DIZ(19008.2,"C",DATETIME,IEN))
 .;W !,"IEN=",IEN
 .I FLAG=0 I IEN'="" W !,"IEN=",IEN S DIK="^DIZ(19008.2,",DA=IEN D ^DIK
 Q 
 
]]></Routine>
</Export>
